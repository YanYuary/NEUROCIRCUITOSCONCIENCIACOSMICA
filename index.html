<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Primera P√°gina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.3/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <meta name="theme-color" id="themeColorMeta" content="#ffffff">
    <style>
        /* Aqu√≠ puedes a√±adir tus estilos CSS */
        :root {
            --app-bg: #f0f2f5;
            --header-bg: #e0e2e5;
            --text-color: #333;
            --text-secondary-color: #666;
            --text-tertiary-color: #999;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --divider-color: #ccc;
            --input-bg: #f9f9f9;
            --input-border: #ddd;
            --primary-accent-color: #6a0dad; /* Morado */
            --secondary-accent-color: #9370db; /* Morado claro */
            --success-color: #28a745;
            --danger-color: #dc3545;
            --button-hover-bg: #f0f0f0;
            --modal-bg: rgba(0, 0, 0, 0.5);
            --modal-content-bg: #ffffff;
            --modal-border: #ccc;
            --tooltip-bg: #333;
            --tooltip-text: #fff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --reaction-button-bg: #f0f0f0;
            --reaction-button-hover: #e0e0e0;
            --reaction-button-active: #d0d0d0;
            --post-border-color: #e0e0e0;
            --post-hover-shadow: rgba(0, 0, 0, 0.15);
            --board-selector-bg: #e0e0e0;
            --board-selector-active-bg: #6a0dad;
            --board-selector-active-text: #fff;
            --admin-toggle-color: #666;
            --admin-toggle-hover: #333;
        }

        .dark-theme {
            --app-bg: #1a1a2e;
            --header-bg: #16213e;
            --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0;
            --text-tertiary-color: #777;
            --card-bg: #0f3460;
            --border-color: #0d2a4d;
            --divider-color: #0a203c;
            --input-bg: #113c6e;
            --input-border: #0f3460;
            --primary-accent-color: #e94560; /* Rosa ne√≥n */
            --secondary-accent-color: #533483; /* Morado oscuro */
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --button-hover-bg: #2b3a57;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --modal-content-bg: #16213e;
            --modal-border: #0d2a4d;
            --tooltip-bg: #e0e0e0;
            --tooltip-text: #333;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --reaction-button-bg: #2b3a57;
            --reaction-button-hover: #3e5c76;
            --reaction-button-active: #537a96;
            --post-border-color: #0d2a4d;
            --post-hover-shadow: rgba(0, 0, 0, 0.4);
            --board-selector-bg: #2b3a57;
            --board-selector-active-bg: #e94560;
            --board-selector-active-text: #fff;
            --admin-toggle-color: #a0a0a0;
            --admin-toggle-hover: #e0e0e0;
            --icon-color: #a0a0a0; /* Color por defecto para iconos no activos */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--app-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .app-header {
            background-color: var(--header-bg);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px var(--shadow-color);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        .app-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-accent-color);
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px var(--shadow-color);
        }

        .app-header h1 a {
            text-decoration: none;
            color: inherit;
        }

        .app-header p {
            font-size: 1.2rem;
            color: var(--text-secondary-color);
        }

        .container {
            max-width: 1200px;
        }

        .board-selectors-container button {
            background-color: var(--board-selector-bg);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* rounded-full */
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .board-selectors-container button:hover {
            background-color: var(--button-hover-bg);
        }

        .board-selectors-container button.active {
            background-color: var(--board-selector-active-bg);
            color: var(--board-selector-active-text);
            border-color: var(--board-selector-active-bg);
        }

        #boardInfo {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        #boardInfo h2 {
            color: var(--primary-accent-color);
        }

        #boardInfo p {
            color: var(--text-secondary-color);
        }

        .post-form-card {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px var(--shadow-color);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-accent-color);
            box-shadow: 0 0 0 2px rgba(106, 13, 173, 0.2); /* Sombra morada */
        }

        .post-input-area {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .post-input-area textarea {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            resize: none;
            overflow-y: hidden;
            min-height: 40px;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .post-input-area textarea:focus {
            outline: none;
            border-color: var(--primary-accent-color);
            box-shadow: 0 0 0 2px rgba(106, 13, 173, 0.2);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-accent-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            flex-shrink: 0;
            box-shadow: 0 2px 4px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        .post-actions-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .icon-button {
            background: none;
            border: none;
            color: var(--icon-color);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-button:hover {
            background-color: var(--button-hover-bg);
            color: var(--primary-accent-color);
        }

        .submit-button {
            background-color: var(--primary-accent-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            margin-left: auto; /* Empuja el bot√≥n al final */
            transition: background-color 0.2s ease;
        }

        .submit-button:hover:not(:disabled) {
            background-color: var(--secondary-accent-color);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .typing-effect {
            color: var(--text-secondary-color);
            font-style: italic;
        }

        .post {
            background-color: var(--card-bg);
            border: 1px solid var(--post-border-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative; /* Para el tooltip */
        }

        .post:hover {
            box-shadow: 0 6px 12px var(--post-hover-shadow);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .post-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary-accent-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            box-shadow: 0 1px 3px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .post-userinfo {
            display: flex;
            flex-direction: column;
        }

        .post-username {
            font-weight: 600;
            color: var(--primary-accent-color);
        }

        .post-timestamp {
            font-size: 0.75rem;
            color: var(--text-tertiary-color);
        }

        .post-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .post-content {
            color: var(--text-color);
            word-wrap: break-word;
            white-space: pre-wrap; /* Para respetar saltos de l√≠nea */
        }

        .post-image-container {
            max-width: 100%;
            overflow: hidden;
            border-radius: 8px;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .post-image-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--divider-color);
        }

        .reaction-button {
            background-color: var(--reaction-button-bg);
            color: var(--text-secondary-color);
            padding: 0.4rem 0.8rem;
            border-radius: 9999px; /* rounded-full */
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .reaction-button:hover {
            background-color: var(--reaction-button-hover);
            color: var(--primary-accent-color);
        }

        .reaction-button:active {
            background-color: var(--reaction-button-active);
        }

        .reaction-button svg {
            width: 1rem;
            height: 1rem;
        }

        .delete-button {
            color: var(--danger-color);
        }
        .delete-button:hover {
            background-color: var(--danger-color);
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        .modal.flex {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: var(--modal-content-bg);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 8px 16px var(--shadow-color);
            max-width: 90%;
            width: 400px;
            border: 1px solid var(--modal-border);
            transform: translateY(-20px);
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }

        .modal.flex .modal-content {
            transform: translateY(0);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .primary-button {
            background-color: var(--primary-accent-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .primary-button:hover {
            background-color: var(--secondary-accent-color);
        }

        .secondary-button {
            background-color: var(--button-hover-bg);
            color: var(--text-color);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .secondary-button:hover {
            background-color: var(--border-color);
        }

        .modal-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--primary-accent-color);
            box-shadow: 0 0 0 2px rgba(106, 13, 173, 0.2);
        }

        .app-footer {
            text-align: center;
            padding: 2rem;
            margin-top: 2rem;
            color: var(--text-secondary-color);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--header-bg);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .app-footer p {
            margin-bottom: 0.5rem;
        }

        .admin-panel {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 500;
        }

        .admin-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            color: var(--admin-toggle-color);
            transition: color 0.2s ease, background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-toggle:hover {
            background-color: var(--button-hover-bg);
            color: var(--admin-toggle-hover);
        }

        #audioToggle {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--icon-color);
            transition: color 0.2s ease;
        }

        #audioToggle:hover {
             color: var(--primary-accent-color);
        }

        .file-upload-label {
            background-color: var(--secondary-accent-color);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .file-upload-label:hover {
            background-color: var(--primary-accent-color);
        }

        .reply-link {
            color: var(--primary-accent-color);
            text-decoration: underline;
            position: relative;
            cursor: pointer;
        }

        .reply-link:hover {
            color: var(--secondary-accent-color);
        }

        .reply-link .tooltip-text {
            visibility: hidden;
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text);
            text-align: left;
            border-radius: 6px;
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Posici√≥n encima del elemento */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            min-width: 150px;
            box-shadow: 0 2px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
            pointer-events: none; /* Para que no bloquee clics */
            white-space: normal; /* Permitir que el texto se ajuste */
            font-size: 0.75rem;
        }

        .reply-link:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .reply-link .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--tooltip-bg) transparent transparent transparent;
        }

        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow-color);
            padding: 0.5rem;
            display: grid;
            grid-template-columns: repeat(6, 1fr); /* 6 columnas */
            gap: 0.25rem;
            z-index: 10;
            bottom: calc(100% + 10px); /* Arriba del bot√≥n/avatar */
            left: 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
        }

        .emoji-picker.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .emoji-option {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background-color 0.1s ease;
        }

        .emoji-option:hover {
            background-color: var(--button-hover-bg);
        }

        /* Specific positioning for main emoji picker */
        #emojiPicker {
            left: 40px; /* Ajustar seg√∫n el tama√±o del avatar */
            bottom: calc(100% + 10px);
        }

        /* Specific positioning for avatar picker */
        .avatar-picker {
            left: 0; /* Alineado con el avatar */
            bottom: calc(100% + 10px);
        }

        /* Tarot Game Styles */
        #tarotGameContainer {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        #tarotInitialCardContainer {
            width: 150px;
            height: 250px;
            perspective: 1000px;
            margin-bottom: 2rem;
        }

        .tarot-initial-card {
            width: 100%;
            height: 100%;
            background-color: var(--secondary-accent-color);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: transform 0.5s ease, opacity 0.5s ease;
            transform-style: preserve-3d;
        }

        .tarot-initial-card.spin {
            animation: spin-card 1s forwards;
        }

        @keyframes spin-card {
            0% { transform: rotateY(0deg); opacity: 1; }
            100% { transform: rotateY(720deg); opacity: 0; }
        }

        #tarotSpreadContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }

        .tarot-row {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
        }

        .tarot-card {
            width: 100px;
            height: 160px;
            background-color: var(--secondary-accent-color);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            transform-style: preserve-3d;
            transform: translateY(20px); /* Initial state for animation */
            opacity: 0; /* Initial state for animation */
        }

        .tarot-card.placed {
            transform: translateY(0);
            opacity: 1;
        }

        .tarot-card:hover {
            box-shadow: 0 4px 10px var(--shadow-color);
            transform: translateY(-5px);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
        }

        .card-back {
            background-color: var(--secondary-accent-color);
            color: white;
            font-size: 3rem;
        }

        .card-front {
            background-color: var(--card-bg);
            transform: rotateY(180deg);
            padding: 5px;
        }

        .tarot-card.flipped {
            transform: rotateY(180deg);
        }

        .tarot-card.selected-for-info {
            border: 2px solid var(--primary-accent-color);
            box-shadow: 0 0 0 3px var(--primary-accent-color);
        }

        .tarot-image-display {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        #tarotCardInfoDisplay {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        #tarotCardInfoDisplay h3 {
            color: var(--primary-accent-color);
        }

        #tarotCardInfoDisplay img {
            border: 1px solid var(--border-color-light);
        }

        #tarotCardInfoDisplay p {
            color: var(--text-secondary-color);
        }

        #tarotCardInfoDisplay strong {
            color: var(--text-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-header h1 {
                font-size: 1.8rem;
            }
            .app-header p {
                font-size: 1rem;
            }
            .post-form-card, #boardInfo, .post {
                padding: 1rem;
            }
            .post-input-area {
                flex-direction: column;
                align-items: stretch;
            }
            .avatar {
                margin-bottom: 0.5rem;
            }
            .post-actions-row {
                flex-wrap: wrap;
            }
            .submit-button {
                margin-left: 0;
                width: 100%;
                margin-top: 0.5rem;
            }
            .post-actions {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .reaction-button {
                width: auto;
            }
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
            .emoji-picker {
                grid-template-columns: repeat(4, 1fr); /* Menos columnas en m√≥vil */
            }
            #emojiPicker {
                left: 0; /* Ajustar posici√≥n para m√≥vil */
                bottom: calc(100% + 10px);
            }
            .tarot-card {
                width: 80px;
                height: 130px;
                font-size: 2rem;
            }
            .tarot-initial-card {
                width: 120px;
                height: 200px;
                font-size: 4rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="app-header text-center">
        <h1><a href="#board=meta" aria-label="Ir al tablero principal /meta/">üß† NeuroChan</a></h1>
        <p id="boardTitle">/meta/ Tableros de la Mente</p>
    </header>

    <div class="container mx-auto px-4 py-2 md:py-4">
        <div class="board-selectors-container flex flex-wrap gap-2 mb-6 justify-center">
            <button class="board-selector active" data-board="meta" aria-label="Tablero meta">
                /meta/
            </button>
            <button class="board-selector" data-board="dreams" aria-label="Tablero sue√±os">
                /sue√±os/
            </button>
            <button class="board-selector" data-board="techno" aria-label="Tablero tecnosoma">
                /tecnosoma/
            </button>
            <button class="board-selector" data-board="retro" aria-label="Tablero retro anime">
                /retro-anime/
            </button>
            <button class="board-selector" data-board="tarot" aria-label="Tablero tarot">
                /tarot/
            </button>
        </div>

        <div id="boardInfo" class="mb-8">
            <h2 class="text-xl font-semibold mb-1">/meta/ - Metaprogramaci√≥n y Viaje Dimensional</h2>
            <p class="text-sm mb-1">Temas: Neurocircuitos, Egocuerpos, Realidades Paralelas, Est√©tica Retro Anime</p>
            <p class="text-xs">Todos los posts son persistentes y se sincronizan en tiempo real.</p>
        </div>

        <div id="postFormContainer" class="post-form-card relative">
            <input
                id="postName"
                class="input-field mb-2"
                placeholder="Nombre (opcional)"
                maxlength="30"
                aria-label="Nombre del usuario">
            <input
                id="postTitle"
                class="input-field mb-3"
                placeholder="T√≠tulo del Post (opcional)"
                maxlength="100"
                aria-label="T√≠tulo del post">

            <div class="post-input-area mb-2">
                <div id="mainPostAvatar" class="avatar relative cursor-pointer"></div>
                <div id="mainAvatarPicker" class="emoji-picker avatar-picker"></div> <div class="relative flex-grow">
                    <textarea
                        id="postContent"
                        class="w-full focus:ring-0"
                        rows="1"
                        placeholder="¬øQu√© est√°s pensando...?"
                        aria-label="Contenido del post"></textarea>
                    <div id="emojiPicker" class="emoji-picker"></div>
                </div>
            </div>

            <div class="post-actions-row">
                <button id="emojiToggle" class="icon-button" aria-label="Abrir selector de emojis">üòä</button>
                <label for="fileUpload" class="icon-button" aria-label="Subir imagen">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                </label>
                <input type="file" id="fileUpload" class="hidden" accept="image/*" aria-hidden="true">
                <span id="fileName" class="text-xs text-gray-500 ml-2 self-center"></span>

                <button id="postPasswordToggle" class="icon-button" aria-label="Establecer contrase√±a para el post">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.078 2.25c-.217-.065-.437-.12-.65-.173a1.75 1.75 0 00-1.946.002c-.213.053-.433.108-.65.173C5.77 3.072 4.5 5.25 4.5 7.5c0 1.97.823 3.717 2.096 4.904.284.344.468.756.528 1.186a3.5 3.5 0 00.878 2.033L9.18 16.06a1.75 1.75 0 002.64 0l.178-.445a3.5 3.5 0 00.878-2.033c.06-.43.243-.842.528-1.186C14.677 11.217 15.5 9.47 15.5 7.5c0-2.25-1.27-4.428-3.344-5.078zM10 9.5a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                </button>

                <button id="submitPost" class="icon-button submit-button" aria-label="Enviar post">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.571V11a1 1 0 112 0v5.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                </button>
            </div>
            <div id="typingPreview" class="mt-4 p-3 hidden">
                <p id="typingText" class="typing-effect"></p>
            </div>
        </div>

        <div id="loadingMessage" class="hidden">Cargando transmisiones...</div>

        <div id="postsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>

        <div id="threadContainer" class="hidden mt-8">
            </div>

        <div id="tarotGameContainer" class="hidden flex flex-col items-center p-4">
            <h2 class="text-2xl font-semibold mb-6">Lectura de Tarot Piramidal</h2>
            <div id="tarotInitialCardContainer" class="mb-6">
                <div id="tarotDeckCard" class="tarot-initial-card">üîÆ</div>
            </div>
            <div class="mb-6 flex gap-4">
                <button id="shuffleTarotButton" class="primary-button">Barajar y Tirar Cartas</button>
                </div>
            <div id="tarotSpreadContainer" class="grid gap-2 justify-items-center w-full">
                </div>
            <div id="tarotCardInfoDisplay" class="hidden mt-6 p-6 w-full md:max-w-2xl rounded-lg">
                <h3 id="tarotCardNameInfo" class="text-xl font-semibold text-center mb-3"></h3>
                <img id="tarotCardImageInfo" src="#" alt="Carta del Tarot Seleccionada" class="mx-auto my-3 max-h-60 rounded"/>
                <div class="text-sm space-y-2">
                    <p><strong>Significado (Derecha):</strong> <span id="tarotMeaningUpInfo"></span></p>
                    <p><strong>Significado (Invertida):</strong> <span id="tarotMeaningRevInfo"></span></p>
                    <p><strong>Pregunta Clave:</strong> <span id="tarotQuestionInfo"></span></p>
                </div>
            </div>
        </div>

        <div class="admin-panel flex items-center gap-2">
            <button id="settingsToggle" class="admin-toggle" aria-label="Configuraci√≥n">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M11.078 2.25c-.217-.065-.437-.12-.65-.173a1.75 1.75 0 00-1.946.002c-.213.053-.433.108-.65.173C5.77 3.072 4.5 5.25 4.5 7.5c0 1.97.823 3.717 2.096 4.904.284.344.468.756.528 1.186a3.5 3.5 0 00.878 2.033L9.18 16.06a1.75 1.75 0 002.64 0l.178-.445a3.5 3.5 0 00.878-2.033c.06-.43.243-.842.528-1.186C14.677 11.217 15.5 9.47 15.5 7.5c0-2.25-1.27-4.428-3.344-5.078zM10 9.5a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
            </button>
            <button id="infoToggle" class="admin-toggle" aria-label="Informaci√≥n del sitio">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
            </button>
            <button id="adminLogoutButton" class="admin-toggle" style="display: none;" aria-label="Cerrar sesi√≥n de administrador">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </button>
        </div>

        <div class="fixed bottom-4 right-4">
            <button id="audioToggle" aria-label="Alternar audio">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M12 6a7.975 7.975 0 0115.657 2.343m0 0a7.975 7.975 0 010 11.314m-11.314 0a7.975 7.975 0 010-11.314m0 0a7.975 7.975 0 0115.657-2.343" />
                </svg>
            </button>
        </div>
    </div>

    <audio id="bgAudio" loop>
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-explosion-1699.mp3" type="audio/mpeg">
    </audio>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Configuraci√≥n</h3>
                <button id="closeSettingsModal" class="text-2xl font-bold leading-none hover:text-gray-700">&times;</button>
            </div>
            <div class="space-y-4" id="settingsModalContent">
                <button id="themeToggleModalButton" class="secondary-button w-full">Cambiar Tema</button>

                <div id="adminControlAreaSettings">
                    <button id="adminLoginModalButton" class="secondary-button w-full">Iniciar Sesi√≥n como Administrador</button>
                    <button id="adminLogoutFromSettingsButton" class="secondary-button w-full" style="display: none; background-color: var(--danger-color); color: white;">Cerrar Sesi√≥n de Administrador</button>
                </div>

                <div id="adminPasswordInputAreaSettings" class="mt-4 pt-4 border-t border-[var(--divider-color)]" style="display: none;">
                    <h4 class="text-md font-semibold mb-2">Acceso de Administrador</h4>
                    <label for="adminPasswordSettingsInput" class="block text-sm mb-1">Contrase√±a Maestra:</label>
                    <input type="password" id="adminPasswordSettingsInput" class="w-full p-2 mb-3 modal-input">
                    <div class="flex gap-2 mt-2">
                        <button id="cancelAdminLoginSettings" class="secondary-button flex-1">Cancelar</button>
                        <button id="confirmAdminLoginSettings" class="primary-button flex-1" style="background-color: var(--success-color);">Acceder</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="postPasswordModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="postPasswordModalTitle" class="text-xl font-semibold">Establecer Contrase√±a</h3>
                <button id="closePostPasswordModal" class="text-2xl font-bold leading-none hover:text-gray-700">&times;</button>
            </div>
            <p id="postPasswordModalMessage" class="mb-4 text-sm">Establece una contrase√±a para poder editar o borrar este post en el futuro.</p>
            <div id="postPasswordModalNameField" class="mb-3" style="display: none;">
                <label for="postPasswordModalNameInput" class="block text-sm mb-1">Tu Nombre (opcional):</label>
                <input type="text" id="postPasswordModalNameInput" class="w-full p-2" maxlength="30" placeholder="An√≥nimo">
            </div>
            <label for="postPasswordModalInput" class="block text-sm mb-1">Contrase√±a (opcional):</label>
            <input type="password" id="postPasswordModalInput" class="w-full p-2 mb-4">
            <div class="modal-actions">
                <button id="cancelPostPassword" class="secondary-button">Cancelar</button>
                <button id="confirmPostPassword" class="primary-button">Aceptar</button>
            </div>
        </div>
    </div>


    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl mb-4">Confirmar borrado</h3>
            <p class="mb-4">Introduce la contrase√±a para borrar este post:</p>
            <input type="password" id="deletePasswordInput" class="w-full p-2 mb-4">
            <div class="modal-actions">
                <button id="cancelDelete" class="secondary-button">Cancelar</button>
                <button id="confirmDelete" class="primary-button" style="background-color: var(--danger-color);">Borrar</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content max-w-md">
            <h3 class="text-xl mb-4">Editar Transmisi√≥n</h3>

            <div id="editPasswordPromptContainer" class="mb-4" style="display: none;">
                <label for="editPostPasswordPrompt" class="block mb-1 text-sm">Contrase√±a del Post (para editar):</label>
                <input type="password" id="editPostPasswordPrompt" class="w-full p-2">
            </div>

            <label for="editPostName" class="block mb-1 text-sm">Nombre:</label>
            <input id="editPostName" class="w-full p-2 mb-2" maxlength="30">

            <label for="editPostTitle" class="block mb-1 text-sm">T√≠tulo:</label>
            <input id="editPostTitle" class="w-full p-2 mb-2" maxlength="100">

            <label for="editPostContent" class="block mb-1 text-sm">Contenido:</label>
            <textarea id="editPostContent" class="w-full p-3 mb-2" rows="4"></textarea>

            <div class="mb-2">
                <img id="editImagePreview" src="#" alt="Previsualizaci√≥n de imagen" class="max-h-40 mb-2" style="display:none; border: 1px solid var(--border-color-light); border-radius: 6px;">
                <label for="editFileUpload" class="file-upload-label px-3 py-1 text-xs cursor-pointer rounded mr-2">
                    Cambiar Imagen
                </label>
                <input type="file" id="editFileUpload" class="hidden" accept="image/*">
                <span id="editFileName" class="text-xs text-gray-500"></span>
                <label class="ml-2 text-xs"><input type="checkbox" id="removeCurrentImage"> Remover Imagen Actual</label>
            </div>

            <label for="editNewPostPassword" class="block mb-1 text-sm">Nueva Contrase√±a (opcional, dejar en blanco para no cambiar):</label>
            <input type="password" id="editNewPostPassword" class="w-full p-2 mb-4">
            <div class="modal-actions">
                <button id="cancelEdit" class="secondary-button">Cancelar</button>
                <button id="confirmEdit" class="primary-button" style="background-color: var(--success-color);">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl">Acerca de NeuroChan</h3>
                <button id="closeInfoModal" class="text-2xl font-bold leading-none hover:text-gray-700">&times;</button>
            </div>
            <p class="mb-4 text-sm">
                NeuroChan es un espacio para la comunidad espiritual de los "Fungis": aquellos que exploran la conciencia,
                desaf√≠an los metaprogramas del ego que operan en nuestros neurocircuitos y encuentran sabidur√≠a en herramientas como el tarot.
            </p>
            <p class="mb-4 text-sm">
                Aqu√≠ puedes compartir tus experiencias con "inochis" (seres o energ√≠as), encuentros con entidades inorg√°nicas,
                la naturaleza del ego, despertares de conciencia y cualquier tema relacionado con la expansi√≥n de la mente y el esp√≠ritu.
            </p>
            <h4 class="text-lg mb-2 font-semibold">Reglas del Sitio (Gu√≠as Espirituales):</h4>
            <ul class="list-disc list-inside text-sm space-y-1 mb-4">
                <li>Respeta todas las perspectivas y experiencias. El camino espiritual es √∫nico para cada ser.</li>
                <li>No se tolera el proselitismo ni la imposici√≥n de creencias. Comparte, no conviertas.</li>
                <li>Mant√©n un lenguaje consciente y evita ataques personales. La cr√≠tica constructiva es bienvenida, el odio no.</li>
                <li>Este es un espacio para la exploraci√≥n y el aprendizaje mutuo. S√© abierto y curioso.</li>
                <li>La informaci√≥n compartida es para reflexi√≥n personal y no sustituye el consejo profesional (m√©dico, psicol√≥gico, etc.) cuando sea necesario.</li>
            </ul>
            <p class="text-xs text-gray-500">Recuerda: la verdadera sabidur√≠a reside en el coraz√≥n y en la experiencia directa.</p>
        </div>
    </div>

    <div id="genericModal" class="modal">
        <div class="modal-content">
            <h3 id="genericModalTitle" class="text-xl mb-4">Mensaje</h3>
            <p id="genericModalMessage" class="mb-4">Este es un mensaje de ejemplo.</p>
            <div id="genericModalButtons" class="modal-actions">
                <button class="secondary-button generic-modal-close-button">Cerrar</button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <p>&copy; <span id="currentYear"></span> NeuroChan. Todos los derechos reservados a la Madre Tierra y sus habitantes conscientes.</p>
        <p>Un espacio para la exploraci√≥n libre del Ser.</p>
    </footer>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getFirestore, collection, addDoc, onSnapshot,
            doc, deleteDoc, updateDoc, query, where, orderBy,
            increment, serverTimestamp, getDoc, getDocs
            } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import {
            getAuth, signInAnonymously, onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let bcryptInstance;
        // Check if bcrypt is loaded from the CDN
        if (typeof bcrypt !== 'undefined') {
            bcryptInstance = bcrypt;
        } else if (globalThis.dcodeIO && globalThis.dcodeIO.bcrypt) {
            bcryptInstance = globalThis.dcodeIO.bcrypt;
        } else {
            console.error("Bcrypt.js no est√° cargado. Las funciones de contrase√±a no funcionar√°n.");
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDQ6q9KkYS0To-BJEjxQSQUyQ65C6wam6o",
            authDomain: "neurocircuitos.firebaseapp.com",
            projectId: "neurocircuitos",
            storageBucket: "neurocircuitos.appspot.com",
            messagingSenderId: "988092454441",
            appId: "1:988092454441:web:e260431acea58ada5f2e38",
            measurementId: "G-9678SEZ792"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const postsCollectionRef = collection(db, "Posts");

        (function() {
            const MAX_IMAGE_SIZE = 2 * 1024 * 1024;
            const ADMIN_HASH = '$2a$12$gN31vHGzyvonWERy0c9K6ubv/LRrh6IJmzWgXYlJ8eJJ4vFYAcnVe';

            const EMOJIS = ['üòÄ','üòÇ','ü§£','ü•≤','üòç','ü§Ø','üòé','ü§ñ','üëæ','üëª','üíÄ','üëΩ','üöÄ','üõ∏','üåÄ','üß†','üåå','üîÆ','üî•','‚ö°','üåà','üéÆ','üì∫'];

            const avatars = [
                'üëæ', 'ü§ñ', 'üëπ', 'üëª', 'üíÄ', 'üëΩ', 'üéÆ', 'üïπÔ∏è', 'üîÆ', 'üßø',
                'üëÅÔ∏è', 'üß†', 'ü¶æ', 'ü¶ø', 'üß¨', 'üî≠', 'üõ∏', 'üåå', 'üåÄ', 'üå†'
            ];

            let state = {
                currentBoard: 'meta',
                currentTheme: localStorage.getItem('neurochan_theme') || 'light',
                audioEnabled: false,
                isAdmin: localStorage.getItem('neurochan_admin') === 'true',
                replyTo: null,
                currentDeletePostId: null,
                allPostsData: {},
                currentBoardOPs: [],
                currentEditPostId: null,
                currentEditPostData: null,
                viewingThreadId: null,
                tarotDeck: [],
                tarotSpread: [],
                tarotCardInfoVisible: false,
                tarotInitialCardFlipped: false,
                tempPostPassword: null, // Nuevo: para almacenar la contrase√±a temporalmente
                tempPostName: null,    // Nuevo: para almacenar el nombre temporalmente
                currentPostAvatar: null, // Nuevo: para el avatar del post principal
            };


            const boards = {
                meta: { title: "/meta/ - Metaprogramaci√≥n y Viaje Dimensional", description: "Temas: Neurocircuitos, Egocuerpos, Realidades Paralelas, Est√©tica Retro Anime", footer: "Todos los posts son persistentes y se sincronizan en tiempo real." },
                dreams: { title: "/sue√±os/ - Exploraci√≥n L√∫cida y Oneiron√°utica", description: "Temas: Control de Sue√±os, Hipnagogia, Sue√±os Compartidos, Proyecci√≥n Astral", footer: "El mundo de los sue√±os es tan real como el de la vigilia. Los l√≠mites son delgados." },
                techno: { title: "/tecnosoma/ - Conciencia Cibern√©tica", description: "Temas: Aumento Neural, Tecnolog√≠a Cyberpunk, Interfaces Mente-M√°quina", footer: "La carne es d√©bil. La m√°quina est√° dispuesta. La mente es eterna." },
                retro: { title: "/retro-anime/ - Nostalgia Neon y Delirio Cyber", description: "Temas: Anime Cl√°sico, Retro-Futurismo, Est√©tica Cyberpunk", footer: "Fantasmas en la m√°quina. Recuerdos en la est√°tica. Sue√±os en los datos." },
                tarot: { title: "/tarot/ - Arcanos y Sincronicidad", description: "Temas: Lecturas de Tarot, Simbolismo Arcano, Adivinaci√≥n, Conexi√≥n Espiritual", footer: "Las cartas revelan los ecos del alma y los susurros del destino." }
            };

            const tarotDeckData = [
                { cartnumber: 0, namecart: "The Fool", significado1cart: "Inicio, potencial ilimitado, fe en el camino", significado2cart: "Circuit 1 ‚Äì Biosupervivencia: seguridad, confiar en la vida", significado3cart: "Visualiza una luz c√°lida en tu ombligo mientras contemplas la carta y respira profundo.", urlcart: "https://video-genesis.com/NFT/wp-content/uploads/2023/11/0foolStrength-BOTAtarot.jpg" },
                { cartnumber: 1, namecart: "The Magician", significado1cart: "Voluntad consciente, capacidad de manifestar", significado2cart: "Circuit 2 ‚Äì Emocional/Territorial: energ√≠a, poder personal", significado3cart: "Siente c√≥mo la emoci√≥n que evoca la imagen sube por tu plexo y af√≠rmala con un gesto.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2020/08/1.BOTA_Tarot_The-Magician.jpg" },
                { cartnumber: 2, namecart: "High Priestess", significado1cart: "Intuici√≥n, misterios velados, sabidur√≠a interna", significado2cart: "Circuit 3 ‚Äì Simb√≥lico/Racional: lenguaje y l√≥gica", significado3cart: "Toma la carta, escribe tres s√≠mbolos o palabras que surjan y observa sus conexiones.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2020/08/2.BOTA_Tarot_The-High-Priestess.jpg" },
                { cartnumber: 3, namecart: "The Empress", significado1cart: "Creatividad, fertilidad, abundancia", significado2cart: "Circuit 4 ‚Äì Socio‚Äësexual: pertenencia e identidad", significado3cart: "Comparte tu interpretaci√≥n con alguien cercano y observa la resonancia mutua.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2020/08/3.BOTA_Tarot_The-Empress.jpg" },
                { cartnumber: 4, namecart: "The Emperor", significado1cart: "Estructura, autoridad, disciplina", significado2cart: "Circuit 5 ‚Äì Neuro‚Äësom√°tico: √©xtasis corporal, bienestar", significado3cart: "Haz respiraci√≥n consciente moviendo el cuerpo con la imagen presente ante ti.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/4-bota_tarot_the-emperor.jpg" },
                { cartnumber: 5, namecart: "The Hierophant", significado1cart: "Tradici√≥n, gu√≠a espiritual, aprendizaje", significado2cart: "Circuit 6 ‚Äì Neuro‚Äëel√©ctrico: intuici√≥n, visi√≥n hol√≠stica", significado3cart: "Medita 10 minutos con la carta frente al entrecejo, dejando llegar flashes intuitivos.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2020/08/5.BOTA_Tarot_The-Hierophant.jpg" },
                { cartnumber: 6, namecart: "The Lovers", significado1cart: "Integraci√≥n de opuestos, elecci√≥n consciente", significado2cart: "Circuit 7 ‚Äì Neuro‚Äëgen√©tico: consciencia arquet√≠pica", significado3cart: "Antes de dormir, coloca la carta bajo la almohada y anota sue√±os al despertar.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2020/08/6.BOTA_Tarot_The-Lovers.jpg" },
                { cartnumber: 7, namecart: "The Chariot", significado1cart: "Dominio de fuerzas, autodirecci√≥n", significado2cart: "Circuit 8 ‚Äì Cu√°ntico‚Äëno√©tico: trascendencia, unidad", significado3cart: "Realiza una sesi√≥n de meditaci√≥n profunda (theta) sosteniendo la carta en la mano.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/7-bota_tarot_the-chariot.jpg" },
                { cartnumber: 8, namecart: "Strength", significado1cart: "Valor, autocontrol emocional, compasi√≥n", significado2cart: "Circuit 1 ‚Äì Biosupervivencia: seguridad, confiar en la vida", significado3cart: "Visualiza una luz c√°lida en tu ombligo mientras contemplas la carta y respira profundo.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/8-bota_tarot_strength.jpg" },
                { cartnumber: 9, namecart: "The Hermit", significado1cart: "B√∫squeda interior, introspecci√≥n, retiro", significado2cart: "Circuit 2 ‚Äì Emocional/Territorial: energ√≠a, poder personal", significado3cart: "Siente c√≥mo la emoci√≥n que evoca la imagen sube por tu plexo y af√≠rmala con un gesto.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/9-bota_tarot_the-hermit.jpg" },
                { cartnumber: 10, namecart: "Wheel of Fortune", significado1cart: "Cambio c√≠clico, destino, oportunidad", significado2cart: "Circuit 3 ‚Äì Simb√≥lico/Racional: lenguaje y l√≥gica", significado3cart: "Toma la carta, escribe tres s√≠mbolos o palabras que surjan y observa sus conexiones.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/10-bota_tarot_wheel-of-fortune.jpg" },
                { cartnumber: 11, namecart: "Justice", significado1cart: "Equilibrio, causa‚Äëefecto, verdad", significado2cart: "Circuit 4 ‚Äì Socio‚Äësexual: pertenencia e identidad", significado3cart: "Comparte tu interpretaci√≥n con alguien cercano y observa la resonancia mutua.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/11-bota_tarot_justice.jpg" },
                { cartnumber: 12, namecart: "The Hanged Man", significado1cart: "Entrega, nueva perspectiva, sacrificio", significado2cart: "Circuit 5 ‚Äì Neuro‚Äësom√°tico: √©xtasis corporal, bienestar", significado3cart: "Haz respiraci√≥n consciente moviendo el cuerpo con la imagen presente ante ti.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/12-bota_tarot_the-hanged-man.jpg" },
                { cartnumber: 13, namecart: "Death", significado1cart: "Transformaci√≥n radical, fin y renacimiento", significado2cart: "Circuit 6 ‚Äì Neuro‚Äëel√©ctrico: intuici√≥n, visi√≥n hol√≠stica", significado3cart: "Medita 10 minutos con la carta frente al entrecejo, dejando llegar flashes intuitivos.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/13-bota_tarot_death.jpg" },
                { cartnumber: 14, namecart: "Temperance", significado1cart: "Alquimia interna, moderaci√≥n, armon√≠a", significado2cart: "Circuit 7 ‚Äì Neuro‚Äëgen√©tico: consciencia arquet√≠pica", significado3cart: "Antes de dormir, coloca la carta bajo la almohada y anota sue√±os al despertar.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/14-bota_tarot_temperance.jpg" },
                { cartnumber: 15, namecart: "The Devil", significado1cart: "Apegos, sombra, liberaci√≥n de cadenas", significado2cart: "Circuit 8 ‚Äì Cu√°ntico‚Äëno√©tico: trascendencia, unidad", significado3cart: "Realiza una sesi√≥n de meditaci√≥n profunda (theta) sosteniendo la carta en la mano.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/15-bota_tarot_the-devil.jpg" },
                { cartnumber: 16, namecart: "The Tower", significado1cart: "Colapso de estructuras falsas, revelaci√≥n", significado2cart: "Circuit 1 ‚Äì Biosupervivencia: seguridad, confiar en la vida", significado3cart: "Visualiza una luz c√°lida en tu ombligo mientras contemplas la carta y respira profundo.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/16-bota_tarot_the-tower.jpg" },
                { cartnumber: 17, namecart: "The Star", significado1cart: "Esperanza, inspiraci√≥n, fluidez", significado2cart: "Circuit 2 ‚Äì Emocional/Territorial: energ√≠a, poder personal", significado3cart: "Siente c√≥mo la emoci√≥n que evoca la imagen sube por tu plexo y af√≠rmala con un gesto.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/17-bota_tarot_the-star.jpg" },
                { cartnumber: 18, namecart: "The Moon", significado1cart: "Inconsciente, ilusi√≥n, prueba emocional", significado2cart: "Circuit 3 ‚Äì Simb√≥lico/Racional: lenguaje y l√≥gica", significado3cart: "Toma la carta, escribe tres s√≠mbolos o palabras que surjan y observa sus conexiones.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/18-bota_tarot_the-moon.jpg" },
                { cartnumber: 19, namecart: "The Sun", significado1cart: "Claridad, vitalidad, realizaci√≥n", significado2cart: "Circuit 4 ‚Äì Socio‚Äësexual: pertenencia e identidad", significado3cart: "Comparte tu interpretaci√≥n con alguien cercano y observa la resonancia mutua.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/19-bota_tarot_the-sun.jpg" },
                { cartnumber: 20, namecart: "Judgement", significado1cart: "Llamado superior, resurrecci√≥n, integraci√≥n", significado2cart: "Circuit 5 ‚Äì Neuro‚Äësom√°tico: √©xtasis corporal, bienestar", significado3cart: "Haz respiraci√≥n consciente moviendo el cuerpo con la imagen presente ante ti.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/20-bota_tarot_judgement.jpg" },
                { cartnumber: 21, namecart: "The World", significado1cart: "Plenitud, cierre de ciclo, maestr√≠a", significado2cart: "Circuit 6 ‚Äì Neuro‚Äëel√©ctrico: intuici√≥n, visi√≥n hol√≠stica", significado3cart: "Medita 10 minutos con la carta frente al entrecejo, dejando llegar flashes intuitivos.", urlcart: "https://www.esotericmeanings.com/wp-content/uploads/2016/07/21-bota_tarot_the-world.jpg" }
            ];

            let unsubscribePosts = null;

            document.addEventListener('DOMContentLoaded', function() {
                setupEventListeners();
                setupEmojiPicker();
                setupMainAvatarPicker(); // New: Setup for main avatar picker
                applyInitialTheme();
                if (state.isAdmin) setupAdminPanel();
                document.getElementById('currentYear').textContent = new Date().getFullYear();

                // Asignar un avatar inicial al formulario principal
                state.currentPostAvatar = avatars[Math.floor(Math.random() * avatars.length)];
                document.getElementById('mainPostAvatar').textContent = state.currentPostAvatar;

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Usuario autenticado an√≥nimamente:", user.uid);
                        handleHashChange();
                    } else {
                        console.log("Usuario no autenticado, intentando autenticaci√≥n an√≥nima...");
                        signInAnonymously(auth).catch((error) => {
                            console.error("Error en autenticaci√≥n an√≥nima:", error);
                            let userMessage = 'Error de conexi√≥n. Intenta recargar.';
                            const loadingMessageElement = document.getElementById('loadingMessage');

                            if (loadingMessageElement) {
                                loadingMessageElement.classList.remove('hidden');
                                if (error.code === 'auth/configuration-not-found') {
                                     userMessage = 'ERROR DE CONFIGURACI√ìN DE FIREBASE: El inicio de sesi√≥n an√≥nimo no est√° habilitado. Por favor, ve a tu consola de Firebase -> Authentication -> Sign-in method y habilita el proveedor "An√≥nimo".';
                                    console.error("ACCI√ìN REQUERIDA: Habilita el proveedor de inicio de sesi√≥n 'An√≥nimo' en la secci√≥n 'Authentication' -> 'Sign-in method' de tu Firebase console.");
                                }
                                loadingMessageElement.textContent = userMessage;
                            }
                        });
                    }
                });
                window.addEventListener('hashchange', handleHashChange);
            });

            // --- Funciones para el modal de Configuraci√≥n y Login de Admin ---
            function showAdminLoginInSettings() {
                document.getElementById('adminLoginModalButton').style.display = 'none';
                document.getElementById('adminLogoutFromSettingsButton').style.display = 'none';
                document.getElementById('adminPasswordInputAreaSettings').style.display = 'block';
                document.getElementById('adminPasswordSettingsInput').focus();
            }

            function hideAdminLoginInSettings() {
                document.getElementById('adminPasswordInputAreaSettings').style.display = 'none';
                document.getElementById('adminPasswordSettingsInput').value = '';
                if (state.isAdmin) {
                    document.getElementById('adminLoginModalButton').style.display = 'none';
                    document.getElementById('adminLogoutFromSettingsButton').style.display = 'block';
                } else {
                    document.getElementById('adminLoginModalButton').style.display = 'block';
                    document.getElementById('adminLogoutFromSettingsButton').style.display = 'none';
                }
            }

            function handleAdminLogoutFromSettings() {
                adminLogout();
                document.getElementById('adminLoginModalButton').style.display = 'block';
                document.getElementById('adminLogoutFromSettingsButton').style.display = 'none';
                closeSettingsModal();
            }

            function verifyAdminPasswordFromSettings() {
                const password = document.getElementById('adminPasswordSettingsInput').value;
                if (bcryptInstance && bcryptInstance.compareSync(password, ADMIN_HASH)) {
                    state.isAdmin = true;
                    localStorage.setItem('neurochan_admin', 'true');
                    closeSettingsModal(); // Cerrar el modal de configuraci√≥n
                    setupAdminPanel();
                    showGenericModal("Acceso Concedido", "Has iniciado sesi√≥n como administrador.", [{ text: 'OK', action: closeGenericModal }]);
                    loadContentForBoard();
                } else {
                    showGenericModal("Acceso Denegado", "La contrase√±a de administrador es incorrecta.", [{ text: 'Intentar de Nuevo', action: () => { document.getElementById('adminPasswordSettingsInput').focus(); document.getElementById('adminPasswordSettingsInput').value = ''; } }, { text: 'Cancelar', action: closeGenericModal }]);
                }
            }
            // --- Fin Funciones Modal Configuraci√≥n ---

            function applyInitialTheme() {
                const themeColorMeta = document.getElementById('themeColorMeta');
                if (localStorage.getItem('neurochan_theme') === 'dark') {
                    document.body.classList.add('dark-theme');
                    if (themeColorMeta) {
                        themeColorMeta.setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--dark-app-bg').trim());
                    }
                } else {
                    document.body.classList.remove('dark-theme');
                    if (themeColorMeta) {
                        themeColorMeta.setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--app-bg').trim());
                    }
                }
                updateThemeButtonText();
            }

            function handleHashChange() {
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const postIdFromUrl = params.get('post');
                const boardFromUrl = params.get('board') || state.currentBoard;

                let boardActuallyChanged = false;
                if (boardFromUrl && boardFromUrl !== state.currentBoard) {
                    state.currentBoard = boardFromUrl;
                    boardActuallyChanged = true;
                    document.querySelectorAll('.board-selector').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.board === state.currentBoard);
                    });
                    const boardData = boards[state.currentBoard] || boards.meta;
                    document.getElementById('boardInfo').innerHTML = `
                        <h2 class="text-xl font-semibold mb-1">${boardData.title}</h2>
                        <p class="text-sm mb-1">${boardData.description}</p>
                        <p class="text-xs">${boardData.footer}</p>`;
                    document.getElementById('boardTitle').textContent = state.currentBoard === 'meta' ?
                        "NeuroChan" :
                        `${boardData.title.split(' - ')[0]}`;
                }

                const previousViewingThreadId = state.viewingThreadId;
                state.viewingThreadId = postIdFromUrl || null;

                if (boardActuallyChanged || state.viewingThreadId !== previousViewingThreadId || !unsubscribePosts || (boardFromUrl && boardFromUrl !== 'tarot') || (boardFromUrl === 'tarot' && state.currentBoard === 'tarot') ) {
                    loadContentForBoard();
                }
                updateUiForView();

                // Si se naveg√≥ a un hilo y se debe mostrar el formulario de respuesta
                if (state.viewingThreadId && postIdFromUrl && postIdFromUrl === state.viewingThreadId) {
                    // Esperar un breve momento para que el DOM se actualice con el post del hilo
                    setTimeout(() => {
                        const replyForm = document.querySelector(`#post-${state.viewingThreadId} .reply-form-container`);
                        if (replyForm) {
                            showReplyForm(replyForm, true); // Mostrar y enfocar
                        }
                    }, 300); // Peque√±o retraso
                }
            }

            function loadContentForBoard() {
                if (state.currentBoard === 'tarot') {
                    setupTarotGame();
                } else {
                    loadAndRenderPostsRealtime();
                }
            }


            function setupEventListeners() {
                document.getElementById('submitPost').addEventListener('click', createPost);
                document.getElementById('adminLogoutButton').addEventListener('click', adminLogout);
                setupAudioToggle();
                setupFileUpload();

                document.querySelectorAll('.board-selector').forEach(btn => {
                    btn.addEventListener('click', function() {
                        changeBoard(btn.dataset.board);
                    });
                });

                document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
                document.getElementById('confirmDelete').addEventListener('click', deletePostWithPassword);
                document.getElementById('infoToggle').addEventListener('click', openInfoModal);
                document.getElementById('closeInfoModal').addEventListener('click', closeInfoModal);
                document.getElementById('confirmEdit').addEventListener('click', () => confirmEdit());
                document.getElementById('cancelEdit').addEventListener('click', closeEditModal);

                // Listeners para el nuevo modal de configuraci√≥n
                document.getElementById('settingsToggle').addEventListener('click', openSettingsModal);
                document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
                document.getElementById('themeToggleModalButton').addEventListener('click', toggleTheme);
                document.getElementById('adminLoginModalButton').addEventListener('click', showAdminLoginInSettings);
                document.getElementById('adminLogoutFromSettingsButton').addEventListener('click', handleAdminLogoutFromSettings);
                document.getElementById('confirmAdminLoginSettings').addEventListener('click', verifyAdminPasswordFromSettings);
                document.getElementById('cancelAdminLoginSettings').addEventListener('click', hideAdminLoginInSettings);
                document.getElementById('shuffleTarotButton').addEventListener('click', shuffleAndDealTarot);

                // Nuevos listeners para el modal de contrase√±a de post
                document.getElementById('postPasswordToggle').addEventListener('click', () => openPostPasswordModal(false));
                document.getElementById('closePostPasswordModal').addEventListener('click', closePostPasswordModal);
                document.getElementById('cancelPostPassword').addEventListener('click', closePostPasswordModal);
                document.getElementById('confirmPostPassword').addEventListener('click', confirmPostPassword);

                // Auto-redimensionar textarea
                document.getElementById('postContent').addEventListener('input', autoResizeTextarea);
            }

            function setupEmojiPicker() {
                const emojiToggle = document.getElementById('emojiToggle');
                const emojiPicker = document.getElementById('emojiPicker');
                const textarea = document.getElementById('postContent');
                EMOJIS.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.className = 'emoji-option';
                    emojiBtn.textContent = emoji;
                    emojiBtn.addEventListener('click', function() {
                        insertAtCursor(textarea, emoji);
                        emojiPicker.classList.remove('active');
                        autoResizeTextarea({ target: textarea }); // Redimensionar despu√©s de insertar emoji
                    });
                    emojiPicker.appendChild(emojiBtn);
                });
                emojiToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    emojiPicker.classList.toggle('active');
                });
                document.addEventListener('click', function(e) {
                    if (!emojiPicker.contains(e.target) && e.target !== emojiToggle) {
                        emojiPicker.classList.remove('active');
                    }
                });
            }

            function setupMainAvatarPicker() {
                const mainPostAvatar = document.getElementById('mainPostAvatar');
                const mainAvatarPicker = document.getElementById('mainAvatarPicker');

                avatars.forEach(avatarEmoji => {
                    const avatarBtn = document.createElement('button');
                    avatarBtn.className = 'emoji-option'; // Reusing emoji-option for styling
                    avatarBtn.textContent = avatarEmoji;
                    avatarBtn.addEventListener('click', function() {
                        state.currentPostAvatar = avatarEmoji;
                        mainPostAvatar.textContent = avatarEmoji;
                        mainAvatarPicker.classList.remove('active');
                    });
                    mainAvatarPicker.appendChild(avatarBtn);
                });

                mainPostAvatar.addEventListener('click', function(e) {
                    e.stopPropagation();
                    mainAvatarPicker.classList.toggle('active');
                });

                document.addEventListener('click', function(e) {
                    if (!mainAvatarPicker.contains(e.target) && e.target !== mainPostAvatar) {
                        mainAvatarPicker.classList.remove('active');
                    }
                });
            }


            function insertAtCursor(textarea, text) {
                const startPos = textarea.selectionStart;
                const endPos = textarea.selectionEnd;
                const currentText = textarea.value;
                textarea.value = currentText.substring(0, startPos) + text + currentText.substring(endPos);
                textarea.selectionStart = textarea.selectionEnd = startPos + text.length;
                textarea.focus();
            }

            function autoResizeTextarea(event) {
                const textarea = event.target;
                textarea.style.height = 'auto'; // Reset height to recalculate
                textarea.style.height = textarea.scrollHeight + 'px'; // Set to scroll height
            }

            async function createPost() {
                const contentInput = document.getElementById('postContent').value.trim();
                const name = document.getElementById('postName').value.trim() || state.tempPostName || "An√≥nimo";
                const title = document.getElementById('postTitle').value.trim();
                const password = state.tempPostPassword; // Usar la contrase√±a del estado temporal
                const fileInput = document.getElementById('fileUpload');

                if (!auth.currentUser) {
                    showGenericModal("Error de Autenticaci√≥n", "No est√°s conectado. Por favor, recarga la p√°gina para intentar de nuevo.", [{ text: 'Entendido', action: closeGenericModal }]);
                    console.error("Intento de crear post sin usuario autenticado.");
                    return;
                }

                if (!contentInput && !fileInput.files[0]) {
                    showGenericModal("Atenci√≥n", "El contenido del post no puede estar vac√≠o si no adjuntas una imagen.", [{ text: 'Entendido', action: closeGenericModal }]);
                    return;
                }

                let actualReplyTo = null;
                if (state.viewingThreadId) {
                    actualReplyTo = state.viewingThreadId;
                } else if (state.replyTo) {
                    actualReplyTo = state.replyTo;
                }

                const newPostData = {
                    authorUID: auth.currentUser.uid,
                    avatar: state.currentPostAvatar, // Usar el avatar generado para el post principal
                    board: state.currentBoard,
                    text: DOMPurify.sanitize(contentInput),
                    title: title ? DOMPurify.sanitize(title) : null,
                    image: null,
                    name: name,
                    passwordHash: password && bcryptInstance ? bcryptInstance.hashSync(password, 10) : null,
                    heartCount: 0,
                    funnyCount: 0,
                    angryCount: 0,
                    reactedBy: {},
                    timestamp: serverTimestamp(),
                    replyTo: actualReplyTo,
                };

                const submitButton = document.getElementById('submitPost');
                submitButton.disabled = true;
                submitButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 animate-spin" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 11.414V15a1 1 0 102 0v-3.586l1.293-1.293a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`;

                try {
                    if (fileInput.files[0]) {
                        const file = fileInput.files[0];
                        if (file.size > MAX_IMAGE_SIZE) {
                            showGenericModal("Error de Archivo", "La imagen es demasiado grande. El tama√±o m√°ximo permitido es 2MB.", [{ text: 'Entendido', action: closeGenericModal }]);
                            submitButton.disabled = false;
                            submitButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.571V11a1 1 0 112 0v5.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>`;
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            compressImage(e.target.result, async function(compressedImage) {
                                newPostData.image = compressedImage;
                                await completePostCreationFirestore(newPostData);
                            });
                        };
                        reader.readAsDataURL(file);
                    } else {
                        await completePostCreationFirestore(newPostData);
                    }
                } catch (error) {
                    console.error("Error creando post:", error);
                    showGenericModal("Error", "Ocurri√≥ un error al enviar el post. Por favor, int√©ntalo de nuevo.", [{ text: 'OK', action: closeGenericModal }]);
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.571V11a1 1 0 112 0v5.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>`;
                }
            }

            async function completePostCreationFirestore(postData) {
                try {
                    const docRef = await addDoc(postsCollectionRef, postData);
                    console.log("Post creado con ID: ", docRef.id);

                    document.getElementById('postContent').value = '';
                    document.getElementById('postName').value = '';
                    document.getElementById('postTitle').value = '';
                    document.getElementById('fileUpload').value = '';
                    document.getElementById('fileName').textContent = '';
                    document.getElementById('typingPreview').classList.add('hidden');

                    state.tempPostPassword = null; // Limpiar contrase√±a temporal
                    state.tempPostName = null;     // Limpiar nombre temporal
                    state.replyTo = null;

                    // Generar un nuevo avatar para el pr√≥ximo post principal
                    state.currentPostAvatar = avatars[Math.floor(Math.random() * avatars.length)];
                    document.getElementById('mainPostAvatar').textContent = state.currentPostAvatar;

                    // Resetear altura del textarea
                    const postContentTextarea = document.getElementById('postContent');
                    postContentTextarea.style.height = 'auto';
                    postContentTextarea.style.height = postContentTextarea.scrollHeight + 'px';

                    document.getElementById('postContent').placeholder = state.viewingThreadId
                        ? `Respondiendo al hilo... >>${state.viewingThreadId.slice(-4)}`
                        : "¬øQu√© est√°s pensando...?";

                } catch (error) {
                    console.error("Error guardando post en Firestore:", error);
                    showGenericModal("Error de Guardado", "No se pudo guardar el post en la base de datos. Intenta de nuevo.", [{ text: 'OK', action: closeGenericModal }]);
                } finally {
                    const submitButton = document.getElementById('submitPost');
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.571V11a1 1 0 112 0v5.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>`;
                }
            }

            function compressImage(imageData, callback) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800; const maxHeight = 800;
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } }
                    else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = imageData;
            }

            function updateUiForView() {
                const postsContainer = document.getElementById('postsContainer');
                const threadContainer = document.getElementById('threadContainer');
                const postFormContainer = document.getElementById('postFormContainer');
                const boardInfoSection = document.getElementById('boardInfo');
                const postTitleInput = document.getElementById('postTitle'); // Ahora es un input, no un contenedor
                const tarotGameContainer = document.getElementById('tarotGameContainer');

                if (state.currentBoard === 'tarot') {
                    postsContainer.classList.add('hidden');
                    threadContainer.classList.add('hidden');
                    if (postFormContainer) postFormContainer.classList.add('hidden');
                    if (boardInfoSection) boardInfoSection.classList.remove('hidden');
                    tarotGameContainer.classList.remove('hidden');
                    if (postTitleInput) postTitleInput.style.display = 'block';
                    document.getElementById('postName').style.display = 'block';
                } else if (state.viewingThreadId) {
                    postsContainer.classList.add('hidden');
                    threadContainer.classList.remove('hidden');
                    // Point 1: Keep postFormContainer hidden in thread view
                    if (postFormContainer) postFormContainer.classList.add('hidden');
                    if (boardInfoSection) boardInfoSection.classList.add('hidden');
                    tarotGameContainer.classList.add('hidden');
                    if (postTitleInput) postTitleInput.style.display = 'none'; // Ocultar t√≠tulo en hilos
                    document.getElementById('postName').style.display = 'none'; // Ocultar nombre en hilos
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postName').value = '';
                    document.getElementById('postContent').placeholder = `Respondiendo al hilo... >>${state.viewingThreadId.slice(-4)}`;
                } else {
                    postsContainer.classList.remove('hidden');
                    threadContainer.classList.add('hidden');
                    threadContainer.innerHTML = '';
                    if (postFormContainer) postFormContainer.classList.remove('hidden');
                    if (boardInfoSection) boardInfoSection.classList.remove('hidden');
                    tarotGameContainer.classList.add('hidden');
                    if (postTitleInput) postTitleInput.style.display = 'block'; // Mostrar t√≠tulo en vista de tablero
                    document.getElementById('postName').style.display = 'block'; // Mostrar nombre en vista de tablero
                    document.getElementById('postContent').placeholder = "¬øQu√© est√°s pensando...?";
                }
            }

            function loadAndRenderPostsRealtime() {
                const loadingMessage = document.getElementById('loadingMessage');
                if (loadingMessage) {
                    loadingMessage.classList.remove('hidden');
                    loadingMessage.textContent = 'Cargando transmisiones...';
                }

                if (unsubscribePosts) {
                    unsubscribePosts();
                    unsubscribePosts = null;
                }

                if (!auth.currentUser) {
                    console.log("Esperando autenticaci√≥n para cargar posts...");
                    if (loadingMessage) {
                        loadingMessage.textContent = 'Esperando conexi√≥n segura...';
                         loadingMessage.classList.remove('hidden');
                    }
                    return;
                }

                updateUiForView();

                const postsContainer = document.getElementById('postsContainer');
                if (state.viewingThreadId) {
                    const docRef = doc(db, "Posts", state.viewingThreadId);
                    unsubscribePosts = onSnapshot(docRef, (docSnap) => {
                        const threadContainer = document.getElementById('threadContainer');
                        threadContainer.innerHTML = '';

                        if (docSnap.exists()) {
                            const postData = { id: docSnap.id, ...docSnap.data() };
                            state.allPostsData[postData.id] = postData;
                            const postElement = createPostElement(postData, true, 0); // isThreadParent = true
                            threadContainer.appendChild(postElement);
                            applyPostEffects(postData, postElement);
                            loadAndRenderReplies(postData.id, threadContainer);
                        } else {
                            threadContainer.innerHTML = '<p class="text-center text-red-400">Este post no existe o fue eliminado.</p>';
                        }
                        if (loadingMessage) loadingMessage.classList.add('hidden');
                    }, (error) => {
                        console.error(`Error obteniendo post del hilo ${state.viewingThreadId}:`, error);
                        if (loadingMessage) {
                            loadingMessage.textContent = 'Error al cargar el hilo. Revisa la consola.';
                            loadingMessage.classList.remove('hidden');
                        }
                    });
                } else {
                    const q = query(postsCollectionRef, where("board", "==", state.currentBoard));
                    unsubscribePosts = onSnapshot(q, (querySnapshot) => {
                        let allBoardPosts = [];
                        querySnapshot.forEach(docSnap => {
                            allBoardPosts.push({ id: docSnap.id, ...docSnap.data() });
                        });

                        const ops = [];
                        const repliesByParent = {};
                        allBoardPosts.forEach(p => {
                            state.allPostsData[p.id] = p;
                            if (p.replyTo === null) {
                                ops.push(p);
                            } else {
                                if (!repliesByParent[p.replyTo]) repliesByParent[p.replyTo] = [];
                                repliesByParent[p.replyTo].push(p);
                            }
                        });

                        ops.sort((a, b) => {
                            const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                            const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                            return timeB - timeA;
                        });

                        state.currentBoardOPs = ops;

                        postsContainer.innerHTML = '';
                        if (ops.length === 0) {
                            postsContainer.innerHTML = '<p class="text-center col-span-full">No hay transmisiones en este tablero a√∫n. ¬°S√© el primero!</p>';
                        } else {
                            ops.forEach(opData => {
                                const count = repliesByParent[opData.id] ? repliesByParent[opData.id].length : 0;
                                const postElement = createPostElement(opData, false, count);
                                postsContainer.appendChild(postElement);
                                applyPostEffects(opData, postElement);
                            });
                        }

                        if (loadingMessage) loadingMessage.classList.add('hidden');
                    }, (error) => {
                        console.error("Error obteniendo posts del tablero:", error);
                        if (loadingMessage) {
                            loadingMessage.textContent = 'Error al cargar posts. Revisa la consola.';
                            loadingMessage.classList.remove('hidden');
                        }
                    });
                }
            }

            async function loadAndRenderReplies(parentPostId, threadContainerElement) {
                const repliesQuery = query(postsCollectionRef, where("replyTo", "==", parentPostId));

                const oldRepliesContainer = threadContainerElement.querySelector('.replies-container');
                if (oldRepliesContainer) {
                    oldRepliesContainer.remove();
                }

                const repliesContainer = document.createElement('div');
                repliesContainer.className = 'replies-container ml-4 md:ml-8 mt-4 space-y-4 border-l-2 pl-4';
                repliesContainer.style.borderColor = 'var(--divider-color)';

                try {
                    const querySnapshot = await getDocs(repliesQuery);
                    const repliesData = [];

                    querySnapshot.forEach(function(doc) {
                        const replyData = { id: doc.id, ...doc.data() };
                        repliesData.push(replyData);
                        state.allPostsData[replyData.id] = replyData;
                    });

                    repliesData.sort((a,b) => {
                        const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : new Date(a.timestamp).getTime();
                        const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : new Date(b.timestamp).getTime();
                        return timeA - timeB;
                    });

                    repliesData.forEach(replyData => {
                        const replyElement = createPostElement(replyData, false, 0);
                        repliesContainer.appendChild(replyElement);
                        applyPostEffects(replyData, replyElement);
                    });

                    const opElementInThread = threadContainerElement.querySelector(`.post[data-id="${parentPostId}"] .reply-count-display`);
                    if (opElementInThread) {
                        opElementInThread.textContent = repliesData.length;
                    }

                    if (repliesData.length > 0) {
                         threadContainerElement.appendChild(repliesContainer);
                    } else {
                        const noRepliesMessage = document.createElement('p');
                        noRepliesMessage.className = 'text-sm pl-4 mt-2';
                        noRepliesMessage.style.color = 'var(--text-secondary-color)';
                        noRepliesMessage.textContent = 'A√∫n no hay respuestas en este hilo.';
                        repliesContainer.appendChild(noRepliesMessage);
                        threadContainerElement.appendChild(repliesContainer);
                    }
                } catch (e) {
                    console.error("Error cargando respuestas: ", e);
                    repliesContainer.innerHTML = '<p class="text-red-500">Error al cargar respuestas.</p>';
                    threadContainerElement.appendChild(repliesContainer);
                }
            }

            function applyPostEffects(post, element) {
                // No hay efectos de brillo en el nuevo tema
            }

            function createPostElement(post, isThreadParent = false, replyCount = 0) {
                const postElement = document.createElement('div');
                postElement.className = `post p-4 rounded-lg mb-4`;
                postElement.dataset.id = post.id;
                postElement.id = `post-${post.id}`; // A√±adir ID para f√°cil referencia

                if (isThreadParent) {
                    postElement.classList.add('mb-6');
                    postElement.style.borderWidth = '2px';
                    postElement.style.borderColor = 'var(--primary-accent-color)';
                }

                const postTimestamp = post.timestamp?.toDate ? post.timestamp.toDate() : new Date(post.timestamp);
                const timeString = postTimestamp.toLocaleTimeString ? postTimestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                const contentHtml = getPostContentHtml(post);
                const titleHtml = post.title ? `<h4 class="post-title">${DOMPurify.sanitize(post.title)}</h4>` : '';

                const canShowEditButton = state.isAdmin || (post.passwordHash && post.authorUID === auth.currentUser?.uid);

                const threadViewButtonHtml = !state.viewingThreadId && !post.replyTo ?
                    `<button class="view-thread-button reaction-button" aria-label="Ver hilo" style="color: var(--primary-accent-color);">Ver Hilo (${replyCount})</button>` : '';

                const replyCountHtml = !post.replyTo && !state.viewingThreadId ?
                    `<span class="text-xs ml-2" style="color: var(--text-secondary-color);">Respuestas: <span class="reply-count-display">${replyCount}</span></span>` : '';

                // Reply form for all posts (initially hidden for replies, always visible for OP in thread view)
                const replyFormHtml = `
                    <div class="reply-form-container post-form-card mt-4 p-4" style="display: none;">
                        <div class="post-input-area mb-2">
                            <div class="reply-avatar avatar relative cursor-pointer"></div>
                            <div class="reply-avatar-picker emoji-picker avatar-picker"></div>
                            <div class="relative flex-grow">
                                <textarea
                                    class="reply-content w-full focus:ring-0"
                                    rows="1"
                                    placeholder="Escribe una respuesta..."
                                    aria-label="Contenido de la respuesta"></textarea>
                                <div class="emoji-picker reply-emoji-picker"></div>
                            </div>
                        </div>
                        <div class="post-actions-row">
                            <button class="emoji-toggle icon-button" aria-label="Abrir selector de emojis">üòä</button>
                            <label class="reply-file-upload-label icon-button" aria-label="Subir imagen">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                            </label>
                            <input type="file" class="reply-file-upload hidden" accept="image/*" aria-hidden="true">
                            <span class="reply-file-name text-xs text-gray-500 ml-2 self-center"></span>

                            <button class="reply-password-toggle icon-button" aria-label="Establecer nombre y contrase√±a para la respuesta">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.078 2.25c-.217-.065-.437-.12-.65-.173a1.75 1.75 0 00-1.946.002c-.213.053-.433.108-.65.173C5.77 3.072 4.5 5.25 4.5 7.5c0 1.97.823 3.717 2.096 4.904.284.344.468.756.528 1.186a3.5 3.5 0 00.878 2.033L9.18 16.06a1.75 1.75 0 002.64 0l.178-.445a3.5 3.5 0 00.878-2.033c.06-.43.243-.842.528-1.186C14.677 11.217 15.5 9.47 15.5 7.5c0-2.25-1.27-4.428-3.344-5.078zM10 9.5a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                            </button>

                            <button class="submit-reply icon-button submit-button" aria-label="Enviar respuesta">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.571V11a1 1 0 112 0v5.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                            </button>
                        </div>
                    </div>
                `;


                postElement.innerHTML = `
                    <div class="post-header">
                        <div class="post-avatar">${post.avatar}</div>
                        <div class="post-userinfo">
                            <span class="post-username">${DOMPurify.sanitize(post.name)}</span>
                            <span class="post-timestamp">${timeString} ${post.authorUID === auth.currentUser?.uid ? '<span style="color: var(--success-color);">(T√∫)</span>' : ''} ${replyCountHtml}</span>
                        </div>
                    </div>
                    ${titleHtml}
                    <div class="post-content text-sm mb-2 mt-1">${contentHtml}</div>
                    <div class="post-actions">
                        <div class="flex gap-1 items-center flex-wrap">
                            <button class="reaction-button heart-reaction-button flex items-center gap-1" aria-label="Reaccionar con Coraz√≥n">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                                <span class="count">${post.heartCount || 0}</span>
                            </button>
                            <button class="reaction-button funny-reaction-button flex items-center gap-1" aria-label="Reaccionar con Me Diverte">
                                üòÇ <span class="count">${post.funnyCount || 0}</span>
                            </button>
                            <button class="reaction-button angry-reaction-button flex items-center gap-1" aria-label="Reaccionar con Me Enoja">
                                üò† <span class="count">${post.angryCount || 0}</span>
                            </button>
                            <button class="reply-button reaction-button" aria-label="Responder a este post">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                Responder
                            </button>
                            ${threadViewButtonHtml}
                        </div>
                        <div class="flex items-center">
                            ${state.isAdmin || (post.passwordHash && post.authorUID === auth.currentUser?.uid) ? '<button class="delete-button reaction-button delete" aria-label="Eliminar post"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>' : ''}
                            ${canShowEditButton ? `<button class="edit-button reaction-button" aria-label="Editar post"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>` : ''}
                            <span class="text-xs ml-2" style="color: var(--text-tertiary-color);">ID: ${post.id.slice(-4)}</span>
                        </div>
                    </div>
                    ${replyFormHtml}
                `;

                postElement.querySelector('.heart-reaction-button').addEventListener('click', () => reaccionarCorazon(post.id));
                postElement.querySelector('.funny-reaction-button').addEventListener('click', () => reaccionarMeDiverte(post.id));
                postElement.querySelector('.angry-reaction-button').addEventListener('click', () => reaccionarMeEnoja(post.id));

                const replyBtn = postElement.querySelector('.reply-button');
                if (replyBtn) {
                    replyBtn.addEventListener('click', () => {
                        const replyFormContainer = postElement.querySelector('.reply-form-container');
                        if (state.viewingThreadId) { // If in thread view, toggle the form
                            if (replyFormContainer.style.display === 'none') {
                                showReplyForm(replyFormContainer, true);
                            } else {
                                hideReplyForm(replyFormContainer);
                            }
                        } else { // If in board list view, navigate to thread
                            replyToPost(post.id); // This will change hash and trigger load
                        }
                    });
                }

                const deleteBtn = postElement.querySelector('.delete-button');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        if (state.isAdmin) deletePostFirestore(post.id);
                        else openDeleteModal(post.id, post.passwordHash);
                    });
                }
                const editBtn = postElement.querySelector('.edit-button');
                if (editBtn) {
                    editBtn.addEventListener('click', () => openEditModal(post.id));
                }

                postElement.querySelectorAll('.reply-link').forEach(link => {
                    link.addEventListener('mouseenter', () => showReplyPreview(link.dataset.postId, link));
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        viewThread(link.dataset.postId);
                    });
                });

                const viewThreadBtn = postElement.querySelector('.view-thread-button');
                if (viewThreadBtn) {
                    viewThreadBtn.addEventListener('click', () => viewThread(post.id));
                }

                // Setup reply form for all posts (initially hidden by default CSS)
                const replyFormContainer = postElement.querySelector('.reply-form-container');
                if (replyFormContainer) {
                    setupReplyForm(replyFormContainer, post.id);
                    // Point 1: If it's the OP in thread view, ensure its reply form is visible
                    if (isThreadParent) {
                        showReplyForm(replyFormContainer, false); // Don't auto-focus immediately
                    }
                }

                return postElement;
            }

            function setupReplyForm(formContainer, parentPostId) {
                const replyContentTextarea = formContainer.querySelector('.reply-content');
                const replyEmojiToggle = formContainer.querySelector('.emoji-toggle');
                const replyEmojiPicker = formContainer.querySelector('.reply-emoji-picker');
                const replyFileUploadLabel = formContainer.querySelector('.reply-file-upload-label');
                const replyFileUploadInput = formContainer.querySelector('.reply-file-upload');
                const replyFileNameSpan = formContainer.querySelector('.reply-file-name');
                const replyPasswordToggle = formContainer.querySelector('.reply-password-toggle');
                const submitReplyButton = formContainer.querySelector('.submit-reply');
                const replyAvatarElement = formContainer.querySelector('.reply-avatar');
                const replyAvatarPicker = formContainer.querySelector('.reply-avatar-picker');

                // Assign initial random avatar for this reply form
                let currentReplyAvatar = avatars[Math.floor(Math.random() * avatars.length)];
                replyAvatarElement.textContent = currentReplyAvatar;

                // Setup avatar picker for this reply form
                avatars.forEach(avatarEmoji => {
                    const avatarBtn = document.createElement('button');
                    avatarBtn.className = 'emoji-option';
                    avatarBtn.textContent = avatarEmoji;
                    avatarBtn.addEventListener('click', function() {
                        currentReplyAvatar = avatarEmoji; // Update local avatar for this form
                        replyAvatarElement.textContent = avatarEmoji;
                        replyAvatarPicker.classList.remove('active');
                    });
                    replyAvatarPicker.appendChild(avatarBtn);
                });

                replyAvatarElement.addEventListener('click', function(e) {
                    e.stopPropagation();
                    replyAvatarPicker.classList.toggle('active');
                });
                document.addEventListener('click', function(e) {
                    if (!replyAvatarPicker.contains(e.target) && e.target !== replyAvatarElement) {
                        replyAvatarPicker.classList.remove('active');
                    }
                });


                // Auto-redimensionar textarea de respuesta
                replyContentTextarea.addEventListener('input', autoResizeTextarea);
                replyContentTextarea.addEventListener('blur', (e) => {
                    if (e.target.value.trim() === '' && !replyFileUploadInput.files[0]) {
                        hideReplyForm(formContainer);
                    }
                });

                // Configurar selector de emojis para respuestas
                EMOJIS.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.className = 'emoji-option';
                    emojiBtn.textContent = emoji;
                    emojiBtn.addEventListener('click', function() {
                        insertAtCursor(replyContentTextarea, emoji);
                        replyEmojiPicker.classList.remove('active');
                        autoResizeTextarea({ target: replyContentTextarea });
                    });
                    replyEmojiPicker.appendChild(emojiBtn);
                });
                replyEmojiToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    replyEmojiPicker.classList.toggle('active');
                });
                // Cerrar picker si se hace clic fuera
                document.addEventListener('click', function(e) {
                    if (!replyEmojiPicker.contains(e.target) && e.target !== replyEmojiToggle) {
                        replyEmojiPicker.classList.remove('active');
                    }
                });

                // Manejar subida de archivo para respuestas
                replyFileUploadInput.addEventListener('change', () => {
                    replyFileNameSpan.textContent = replyFileUploadInput.files[0] ? replyFileUploadInput.files[0].name : '';
                });

                // Manejar modal de contrase√±a/nombre para respuestas
                replyPasswordToggle.addEventListener('click', () => openPostPasswordModal(true, parentPostId));

                // Manejar env√≠o de respuesta
                submitReplyButton.addEventListener('click', async () => {
                    const content = replyContentTextarea.value.trim();
                    const name = state.tempPostName || "An√≥nimo"; // Usar el nombre del modal si se estableci√≥
                    const password = state.tempPostPassword; // Usar la contrase√±a del modal si se estableci√≥
                    const file = replyFileUploadInput.files[0];

                    if (!content && !file) {
                        showGenericModal("Atenci√≥n", "El contenido de la respuesta no puede estar vac√≠o si no adjuntas una imagen.", [{ text: 'Entendido', action: closeGenericModal }]);
                        return;
                    }

                    const newReplyData = {
                        authorUID: auth.currentUser.uid,
                        avatar: currentReplyAvatar, // Use the locally selected avatar for this reply
                        board: state.currentBoard,
                        text: DOMPurify.sanitize(content),
                        title: null, // Las respuestas no tienen t√≠tulo
                        image: null,
                        name: name,
                        passwordHash: password && bcryptInstance ? bcryptInstance.hashSync(password, 10) : null,
                        heartCount: 0,
                        funnyCount: 0,
                        angryCount: 0,
                        reactedBy: {},
                        timestamp: serverTimestamp(),
                        replyTo: parentPostId,
                    };

                    submitReplyButton.disabled = true;
                    submitReplyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 animate-spin" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 11.414V15a1 1 0 102 0v-3.586l1.293-1.293a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`;

                    try {
                        if (file) {
                            if (file.size > MAX_IMAGE_SIZE) {
                                showGenericModal("Error de Archivo", "La imagen es demasiado grande. El tama√±o m√°ximo permitido es 2MB.", [{ text: 'Entendido', action: closeGenericModal }]);
                                return;
                            }
                            const reader = new FileReader();
                            reader.onload = async function(e) {
                                compressImage(e.target.result, async function(compressedImage) {
                                    newReplyData.image = compressedImage;
                                    await addDoc(postsCollectionRef, newReplyData);
                                    resetReplyForm(formContainer, replyAvatarElement);
                                });
                            };
                            reader.readAsDataURL(file);
                        } else {
                            await addDoc(postsCollectionRef, newReplyData);
                            resetReplyForm(formContainer, replyAvatarElement);
                        }
                    } catch (error) {
                        console.error("Error creando respuesta:", error);
                        showGenericModal("Error", "Ocurri√≥ un error al enviar la respuesta. Por favor, int√©ntalo de nuevo.", [{ text: 'OK', action: closeGenericModal }]);
                    } finally {
                        submitReplyButton.disabled = false;
                        submitReplyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.571V11a1 1 0 112 0v5.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>`;
                    }
                });
            }

            function resetReplyForm(formContainer, avatarElement) {
                formContainer.querySelector('.reply-content').value = '';
                formContainer.querySelector('.reply-file-upload').value = '';
                formContainer.querySelector('.reply-file-name').textContent = '';
                avatarElement.textContent = avatars[Math.floor(Math.random() * avatars.length)]; // Nuevo avatar para la pr√≥xima respuesta
                state.tempPostName = null;
                state.tempPostPassword = null;
                autoResizeTextarea({ target: formContainer.querySelector('.reply-content') });
                // Do not hide if it's the OP's reply form in thread view
                if (!formContainer.closest('.thread-container')) { // Check if it's a nested reply form
                    hideReplyForm(formContainer);
                }
            }

            function showReplyForm(formContainer, autoFocus = false) {
                formContainer.style.display = 'block';
                if (autoFocus) {
                    formContainer.querySelector('.reply-content').focus();
                }
                autoResizeTextarea({ target: formContainer.querySelector('.reply-content') });
            }

            function hideReplyForm(formContainer) {
                formContainer.style.display = 'none';
            }


            function showReplyPreview(postId, element) {
                const post = state.allPostsData[postId];
                if (!post) {
                    console.warn(`Post ${postId} no encontrado en cach√© para preview.`);
                    return;
                }
                let tooltip = element.querySelector('.tooltip-text');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.className = 'tooltip-text text-xs p-2';
                    let previewContent = post.image ? "[Imagen]" : (post.text ?? '');
                    if (previewContent.length > 100) previewContent = previewContent.substring(0, 100) + '...';
                    tooltip.innerHTML = `
                        <div class="flex items-center mb-1">
                            <span class="post-avatar text-base mr-1">${post.avatar}</span>
                            <span class="text-xs font-semibold">${DOMPurify.sanitize(post.name)}</span>
                        </div>
                        <div class="text-xs">${DOMPurify.sanitize(previewContent)}</div>`;
                    element.appendChild(tooltip);
                }
            }

            function replyToPost(postId) {
                state.replyTo = postId;
                // Navigate to the thread if not already in it (Point 5)
                if (state.viewingThreadId !== postId) {
                    window.location.hash = `board=${state.currentBoard}&post=${postId}`;
                } else {
                    // If already in the thread, simply show the form and focus
                    const replyForm = document.querySelector(`#post-${postId} .reply-form-container`);
                    if (replyForm) {
                        showReplyForm(replyForm, true);
                    }
                }
            }

            function viewThread(postId) {
                window.location.hash = `board=${state.currentBoard}&post=${postId}`;
            }

            function getPostContentHtml(post) {
                let html = '';
                if (post.image) {
                    html += `<div class="post-image-container"><img src="${DOMPurify.sanitize(post.image)}" alt="Imagen del post"></div>`;
                }

                const textContent = typeof post.text === 'string' ? post.text : '';
                let sanitizedText = DOMPurify.sanitize(textContent).replace(/\n/g,'<br>');

                sanitizedText = sanitizedText.replace(/&gt;&gt;(\w+)/g, (match, referencedPostIdSuffix) => {
                    const fullReferencedPost = Object.values(state.allPostsData).find(p => p.id.endsWith(referencedPostIdSuffix));
                    const targetPostId = fullReferencedPost ? fullReferencedPost.id : referencedPostIdSuffix;
                    const targetBoard = fullReferencedPost ? fullReferencedPost.board : state.currentBoard;
                    const threadLinkTargetId = fullReferencedPost ? (fullReferencedPost.replyTo || fullReferencedPost.id) : targetPostId;
                    return `<a href="#board=${targetBoard}&post=${threadLinkTargetId}" class="reply-link" data-post-id="${targetPostId}">>>${referencedPostIdSuffix.slice(-4)}</a>`;
                });

                if (post.text) {
                    html += `<p>${sanitizedText}</p>`;
                }

                return html || (post.image ? '' : '<p style="color: var(--text-tertiary-color);">[sin contenido textual]</p>');
            }

            function updateTypingEffect(text) {
                const preview = document.getElementById('typingPreview');
                const typingText = document.getElementById('typingText');
                if (text.trim().length) {
                    typingText.textContent = text.slice(0, 140);
                    preview.classList.remove('hidden');
                } else {
                    preview.classList.add('hidden');
                }
            }
            document.getElementById('postContent').addEventListener('input', e => updateTypingEffect(e.target.value));

            function setupAudioToggle() {
                const audio = document.getElementById('bgAudio');
                const toggleButton = document.getElementById('audioToggle');
                toggleButton.addEventListener('click', () => {
                    state.audioEnabled = !state.audioEnabled;
                    if (state.audioEnabled) {
                        audio.play().catch(e => console.log("Error al reproducir audio:", e));
                        toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a1 1 0 000 2H4v2a1 1 0 102 0V6h3a1 1 0 100-2H7zM6 8a2 2 0 11-4 0 2 2 0 014 0zM13 4a1 1 0 100 2h3v2a1 1 0 102 0V6h-3a1 1 0 100-2h-3zM14 8a2 2 0 11-4 0 2 2 0 014 0zM4 12a1 1 0 100 2h12a1 1 0 100-2H4z" /></svg>`; // Icono de sonido ON
                        toggleButton.style.color = 'var(--primary-accent-color)';
                    } else {
                        audio.pause();
                        toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`; // Icono de sonido OFF
                        toggleButton.style.color = 'var(--icon-color)';
                    }
                });
            }

            function setupFileUpload() {
                const fileInput = document.getElementById('fileUpload');
                fileInput.addEventListener('change', () => {
                    const span = document.getElementById('fileName');
                    span.textContent = fileInput.files[0] ? fileInput.files[0].name : '';
                });
                 const editFileInput = document.getElementById('editFileUpload');
                editFileInput.addEventListener('change', () => {
                    const span = document.getElementById('editFileName');
                    const preview = document.getElementById('editImagePreview');
                    if (editFileInput.files[0]) {
                        span.textContent = editFileInput.files[0].name;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        }
                        reader.readAsDataURL(editFileInput.files[0]);
                        document.getElementById('removeCurrentImage').checked = false;
                    } else {
                        span.textContent = '';
                    }
                });
            }

            function changeBoard(board, updateHash = true) {
                state.currentBoard = board;
                document.querySelectorAll('.board-selector').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.board === board);
                });
                const boardData = boards[board] || boards.meta;
                const boardInfoEl = document.getElementById('boardInfo');
                boardInfoEl.innerHTML = `
                    <h2 class="text-xl font-semibold mb-1">${boardData.title}</h2>
                    <p class="text-sm mb-1">${boardData.description}</p>
                    <p class="text-xs">${boardData.footer}</p>`;
                document.getElementById('boardTitle').textContent = board === 'meta' ?
                    "NeuroChan" :
                    `${boardData.title.split(' - ')[0]}`;

                if (updateHash) {
                    state.viewingThreadId = null;
                    window.location.hash = `board=${board}`;
                } else {
                    loadContentForBoard();
                }
            }

            function adminLogout() {
                state.isAdmin = false;
                localStorage.removeItem('neurochan_admin');
                showGenericModal("Sesi√≥n Cerrada", "Has cerrado la sesi√≥n de administrador.", [{ text: 'OK', action: closeGenericModal }]);
                document.getElementById('adminLogoutButton').style.display = 'none';
                document.getElementById('adminToggle')?.classList.remove('text-pink-400');
                setupAdminPanel();
                loadContentForBoard();
            }

            async function reactWith(postId, reactionType, reactionField) {
                if (!auth.currentUser) {
                    showGenericModal("Error de Autenticaci√≥n", "Debes estar conectado para reaccionar. Por favor, recarga la p√°gina.", [{ text: 'Entendido', action: closeGenericModal }]);
                    return;
                }
                const userUID = auth.currentUser.uid;
                const postRef = doc(db, "Posts", postId);

                try {
                    const postDoc = await getDoc(postRef);
                    if (!postDoc.exists()) {
                        console.error("El post no existe.");
                        return;
                    }
                    const postData = postDoc.data();
                    let userReactions = postData.reactedBy && postData.reactedBy[userUID] ? [...postData.reactedBy[userUID]] : [];
                    const alreadyReacted = userReactions.includes(reactionType);

                    const updates = {};
                    if (alreadyReacted) {
                        userReactions = userReactions.filter(r => r !== reactionType);
                        updates[reactionField] = increment(-1);
                    } else {
                        userReactions.push(reactionType);
                        updates[reactionField] = increment(1);
                    }
                    updates[`reactedBy.${userUID}`] = userReactions;

                    await updateDoc(postRef, updates);
                } catch (error) {
                    console.error(`Error al reaccionar con ${reactionType}:`, error);
                    showGenericModal("Error de Reacci√≥n", "Ocurri√≥ un error al procesar tu reacci√≥n.", [{ text: 'OK', action: closeGenericModal }]);
                }
            }

            function reaccionarCorazon(postId) { reactWith(postId, 'coraz√≥n', 'heartCount'); }
            function reaccionarMeDiverte(postId) { reactWith(postId, 'me diverte', 'funnyCount'); }
            function reaccionarMeEnoja(postId) { reactWith(postId, 'me enoja', 'angryCount'); }

            function toggleTheme() {
                if (document.body.classList.contains('dark-theme')) {
                    state.currentTheme = 'light';
                } else {
                    state.currentTheme = 'dark';
                }
                applyCurrentTheme();
                saveThemePreference();
            }

            function updateThemeButtonText() {
                const themeToggle = document.getElementById('themeToggleModalButton');
                if (document.body.classList.contains('dark-theme')) {
                    themeToggle.innerHTML = '‚òÄÔ∏è Cambiar a Tema Claro';
                } else {
                    themeToggle.innerHTML = 'üåô Cambiar a Tema Oscuro';
                }
            }

            function saveThemePreference() {
                localStorage.setItem('neurochan_theme', state.currentTheme);
            }

            function applyCurrentTheme() {
                const themeColorMeta = document.getElementById('themeColorMeta');
                if (state.currentTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                    if (themeColorMeta) {
                        themeColorMeta.setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--dark-app-bg').trim());
                    }
                } else {
                    document.body.classList.remove('dark-theme');
                    if (themeColorMeta) {
                        themeColorMeta.setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--app-bg').trim());
                    }
                }
                updateThemeButtonText();
            }


            async function deletePostFirestore(postId) {
                 if (!auth.currentUser) {
                    showGenericModal("Error de Autenticaci√≥n", "Debes estar conectado para borrar. Por favor, recarga la p√°gina.", [{ text: 'Entendido', action: closeGenericModal }]);
                    return;
                }

                showGenericModal(
                    "Confirmar Borrado",
                    "¬øSeguro que quieres borrar este post permanentemente? Esta acci√≥n tambi√©n borrar√° todas sus respuestas y no se puede deshacer.",
                    [
                        { text: 'Cancelar', class: 'secondary-button', action: closeGenericModal },
                        { text: 'Borrar Definitivamente', class: 'primary-button', style: {backgroundColor: 'var(--danger-color)'}, action: async () => {
                            try {
                                const repliesQuery = query(postsCollectionRef, where("replyTo", "==", postId));
                                const repliesSnapshot = await getDocs(repliesQuery);
                                const deletePromises = [];
                                repliesSnapshot.forEach(docReply => {
                                    deletePromises.push(deleteDoc(docReply.ref));
                                });
                                await Promise.all(deletePromises);
                                console.log(`Borradas ${deletePromises.length} respuestas para el post ${postId}`);

                                await deleteDoc(doc(db, "Posts", postId));
                                closeGenericModal();
                                if (state.viewingThreadId === postId) {
                                    window.location.hash = `board=${state.currentBoard}`;
                                }
                            }
                            catch (error) { console.error("Error borrando post y/o respuestas:", error); showGenericModal("Error", "No se pudo borrar el post o sus respuestas.", [{ text: 'OK', action: closeGenericModal }]); }
                        }}
                    ],
                    false
                );
            }

            let currentPostPasswordHash = null;

            function openDeleteModal(postId, passwordHash) {
                state.currentDeletePostId = postId;
                currentPostPasswordHash = passwordHash;
                document.getElementById('deleteModal').classList.add('flex');
                document.getElementById('deletePasswordInput').value = '';
                document.getElementById('deletePasswordInput').focus();
            }

            function closeDeleteModal() {
                state.currentDeletePostId = null;
                currentPostPasswordHash = null;
                document.getElementById('deleteModal').classList.remove('flex');
                document.getElementById('deletePasswordInput').value = '';
            }

            async function deletePostWithPassword() {
                if (!auth.currentUser) {
                    showGenericModal("Error de Autenticaci√≥n", "Debes estar conectado para borrar. Por favor, recarga la p√°gina.", [{ text: 'Entendido', action: closeGenericModal }]);
                    closeDeleteModal();
                    return;
                }
                const passwordAttempt = document.getElementById('deletePasswordInput').value;
                if (!state.currentDeletePostId || currentPostPasswordHash === null) {
                    showGenericModal("Error", "No se puede borrar este post o no requiere contrase√±a.", [{ text: 'Entendido', action: closeGenericModal }]);
                    closeDeleteModal();
                    return;
                }

                if (bcryptInstance && bcryptInstance.compareSync(passwordAttempt, currentPostPasswordHash)) {
                    await deletePostFirestore(state.currentDeletePostId);
                    closeDeleteModal();
                } else {
                     showGenericModal("Error", "Contrase√±a incorrecta.", [{ text: 'Entendido', action: () => document.getElementById('deletePasswordInput').focus() }]);
                }
            }

            function openInfoModal() { document.getElementById('infoModal').classList.add('flex'); }
            function closeInfoModal() { document.getElementById('infoModal').classList.remove('flex'); }

            function openSettingsModal() {
                const adminLoginBtn = document.getElementById('adminLoginModalButton');
                const adminLogoutBtn = document.getElementById('adminLogoutFromSettingsButton');
                const adminPasswordArea = document.getElementById('adminPasswordInputAreaSettings');

                if (state.isAdmin) {
                    adminLoginBtn.style.display = 'none';
                    adminLogoutBtn.style.display = 'block';
                } else {
                    adminLoginBtn.style.display = 'block';
                    adminLogoutBtn.style.display = 'none';
                }
                adminPasswordArea.style.display = 'none';
                document.getElementById('adminPasswordSettingsInput').value = '';
                document.getElementById('settingsModal').classList.add('flex');
            }
            function closeSettingsModal() {
                document.getElementById('settingsModal').classList.remove('flex');
                const adminPasswordArea = document.getElementById('adminPasswordInputAreaSettings');
                if (adminPasswordArea) adminPasswordArea.style.display = 'none';
                const adminLoginBtn = document.getElementById('adminLoginModalButton');
                if (adminLoginBtn && !state.isAdmin) adminLoginBtn.style.display = 'block';
            }

            function setupAdminPanel() {
                const adminLogoutBtn = document.getElementById('adminLogoutButton');
                const adminToggleBtn = document.getElementById('settingsToggle');

                if(state.isAdmin) {
                    if (adminLogoutBtn) adminLogoutBtn.style.display = 'inline-flex';
                    if (adminToggleBtn) adminToggleBtn.style.color = 'var(--primary-accent-color)';
                } else {
                    if (adminLogoutBtn) adminLogoutBtn.style.display = 'none';
                    if (adminToggleBtn) adminToggleBtn.style.color = 'var(--icon-color)';
                }
            }

            function showGenericModal(title, message, buttons = [{ text: 'OK', action: closeGenericModal }], closeModalOnClickOutside = true) {
                const modal = document.getElementById('genericModal');
                document.getElementById('genericModalTitle').textContent = title;
                document.getElementById('genericModalMessage').innerHTML = DOMPurify.sanitize(message);

                const buttonsContainer = document.getElementById('genericModalButtons');
                buttonsContainer.innerHTML = '';

                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    let baseClass = 'secondary-button';
                    if (btnConfig.class && btnConfig.class.includes('primary-button')) {
                        baseClass = 'primary-button';
                    } else if (btnConfig.style && btnConfig.style.backgroundColor === 'var(--danger-color)') {
                        baseClass = 'primary-button';
                    }

                    button.className = `${baseClass} ${btnConfig.class || ''}`;
                    if (btnConfig.style) {
                        Object.assign(button.style, btnConfig.style);
                    }

                    button.addEventListener('click', () => {
                        if (btnConfig.action) btnConfig.action();
                    });
                    buttonsContainer.appendChild(button);
                });

                modal.classList.add('flex');

                if (closeModalOnClickOutside) {
                    const closeModalHandler = function(event) {
                        if (event.target === modal) {
                            closeGenericModal();
                            modal.removeEventListener('click', closeModalHandler);
                        }
                    };
                    modal.addEventListener('click', closeModalHandler);
                } else {
                    modal.onclick = null;
                }
                modal.querySelectorAll('.generic-modal-close-button').forEach(btn => {
                    btn.addEventListener('click', closeGenericModal);
                });
            }

            function closeGenericModal() { document.getElementById('genericModal').classList.remove('flex'); }

            function openEditModal(postId) {
                const postToEdit = state.allPostsData[postId];
                if (!postToEdit) { showGenericModal("Error", "Post no encontrado para editar.", [{ text: 'OK', action: closeGenericModal }]); return; }

                if (!state.isAdmin && !(postToEdit.passwordHash && postToEdit.authorUID === auth.currentUser?.uid)) {
                    showGenericModal("No Autorizado", "No tienes permiso para editar este post.", [{ text: 'OK', action: closeGenericModal }]);
                    return;
                }

                state.currentEditPostId = postId;
                state.currentEditPostData = { ...postToEdit };

                document.getElementById('editPostName').value = postToEdit.name || '';
                document.getElementById('editPostTitle').value = postToEdit.title || '';
                document.getElementById('editPostContent').value = postToEdit.text || '';

                const imagePreview = document.getElementById('editImagePreview');
                const removeCurrentImageCheckbox = document.getElementById('removeCurrentImage');
                if (postToEdit.image) {
                    imagePreview.src = postToEdit.image;
                    imagePreview.style.display = 'block';
                    removeCurrentImageCheckbox.parentElement.style.display = 'inline-block';
                    removeCurrentImageCheckbox.checked = false;
                } else {
                    imagePreview.style.display = 'none';
                    imagePreview.src = '#';
                    removeCurrentImageCheckbox.parentElement.style.display = 'none';
                }
                document.getElementById('editFileUpload').value = '';
                document.getElementById('editFileName').textContent = '';

                const passwordPromptContainer = document.getElementById('editPasswordPromptContainer');
                if (!state.isAdmin && postToEdit.passwordHash) {
                    passwordPromptContainer.style.display = 'block';
                    document.getElementById('editPostPasswordPrompt').value = '';
                    document.getElementById('editPostPasswordPrompt').focus();
                } else {
                    passwordPromptContainer.style.display = 'none';
                }
                document.getElementById('editNewPostPassword').value = '';
                document.getElementById('editModal').classList.add('flex');
            }

            function closeEditModal() {
                document.getElementById('editModal').classList.remove('flex');
                state.currentEditPostId = null;
                state.currentEditPostData = null;
                document.getElementById('editPostName').value = '';
                document.getElementById('editPostTitle').value = '';
                document.getElementById('editPostContent').value = '';
                document.getElementById('editPostPasswordPrompt').value = '';
                document.getElementById('editNewPostPassword').value = '';
                document.getElementById('editFileUpload').value = '';
                document.getElementById('editFileName').textContent = '';
                document.getElementById('editImagePreview').style.display = 'none';
                document.getElementById('removeCurrentImage').checked = false;
            }

            async function confirmEdit() {
                if (!state.currentEditPostId || !state.currentEditPostData || !auth.currentUser) {
                    showGenericModal("Error", "No se puede editar el post en este momento.", [{ text: 'OK', action: closeGenericModal }]);
                    return;
                }

                const originalPostData = state.currentEditPostData;
                const updateData = {};

                if (!state.isAdmin && originalPostData.passwordHash && originalPostData.authorUID === auth.currentUser.uid) {
                    const passwordAttempt = document.getElementById('editPostPasswordPrompt').value;
                    if (!bcryptInstance || !bcryptInstance.compareSync(passwordAttempt, originalPostData.passwordHash)) {
                        showGenericModal("Error de Edici√≥n", "La contrase√±a del post es incorrecta.", [{ text: 'Entendido', action: () => document.getElementById('editPostPasswordPrompt').focus() }]);
                        return;
                    }
                } else if (!state.isAdmin && originalPostData.authorUID !== auth.currentUser.uid) {
                    showGenericModal("Error de Permiso", "No puedes editar un post que no es tuyo sin ser administrador.", [{ text: 'OK', action: closeGenericModal }]);
                    return;
                }

                updateData.name = DOMPurify.sanitize(document.getElementById('editPostName').value.trim()) || "An√≥nimo";
                updateData.title = DOMPurify.sanitize(document.getElementById('editPostTitle').value.trim()) || null;
                updateData.text = DOMPurify.sanitize(document.getElementById('editPostContent').value.trim());

                const newPassword = document.getElementById('editNewPostPassword').value.trim();
                if (newPassword) {
                    if (bcryptInstance) {
                        updateData.passwordHash = bcryptInstance.hashSync(newPassword, 10);
                    } else {
                        showGenericModal("Error de Contrase√±a", "Bcrypt no est√° disponible. No se pudo actualizar la contrase√±a.", [{ text: 'OK', action: closeGenericModal }]);
                    }
                } else {
                    updateData.passwordHash = originalPostData.passwordHash;
                }

                const fileInput = document.getElementById('editFileUpload');
                const removeCurrentImage = document.getElementById('removeCurrentImage').checked;

                const confirmButton = document.getElementById('confirmEdit');
                confirmButton.disabled = true;
                confirmButton.textContent = 'GUARDANDO...';

                if (fileInput.files[0]) {
                    const file = fileInput.files[0];
                    if (file.size > MAX_IMAGE_SIZE) {
                        showGenericModal("Error de Archivo", "La imagen seleccionada es demasiado grande. El m√°ximo es 2MB.", [{ text: 'Entendido', action: closeGenericModal }]);
                        confirmButton.disabled = false;
                        confirmButton.textContent = 'Guardar Cambios';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        compressImage(e.target.result, async function(compressedImage) {
                            updateData.image = compressedImage;
                            await finalizePostUpdate(updateData, confirmButton);
                        });
                    };
                    reader.readAsDataURL(file);
                } else {
                    if (removeCurrentImage) {
                        updateData.image = null;
                    } else {
                        updateData.image = originalPostData.image;
                    }
                    await finalizePostUpdate(updateData, confirmButton);
                }
            }

            async function finalizePostUpdate(updateData, buttonElement) {
                try {
                    updateData.lastEdited = serverTimestamp();
                    await updateDoc(doc(db, "Posts", state.currentEditPostId), updateData);
                    closeEditModal();
                    showGenericModal("√âxito", "El post ha sido actualizado correctamente.", [{ text: 'OK', action: closeGenericModal }]);
                } catch (error) {
                    console.error("Error actualizando post:", error);
                    showGenericModal("Error de Actualizaci√≥n", "No se pudieron guardar los cambios en el post.", [{ text: 'OK', action: closeGenericModal }]);
                } finally {
                    if (buttonElement) {
                        buttonElement.disabled = false;
                        buttonElement.textContent = 'Guardar Cambios';
                    }
                }
            }

            // --- Funciones para el nuevo modal de Contrase√±a de Post/Respuesta ---
            let currentPostPasswordModalCallback = null;

            function openPostPasswordModal(isReply = false) {
                const modal = document.getElementById('postPasswordModal');
                const title = document.getElementById('postPasswordModalTitle');
                const message = document.getElementById('postPasswordModalMessage');
                const nameField = document.getElementById('postPasswordModalNameField');
                const nameInput = document.getElementById('postPasswordModalNameInput');
                const passwordInput = document.getElementById('postPasswordModalInput');

                if (isReply) {
                    title.textContent = "Establecer Nombre y Contrase√±a";
                    message.textContent = "Establece un nombre (opcional) y una contrase√±a (opcional) para poder editar o borrar esta respuesta en el futuro.";
                    nameField.style.display = 'block';
                    nameInput.value = state.tempPostName || ''; // Mantener el nombre si ya se escribi√≥
                    passwordInput.value = state.tempPostPassword || ''; // Mantener la contrase√±a si ya se escribi√≥
                    nameInput.focus();
                } else {
                    title.textContent = "Establecer Contrase√±a del Post";
                    message.textContent = "Establece una contrase√±a (opcional) para poder editar o borrar este post en el futuro.";
                    nameField.style.display = 'none';
                    nameInput.value = '';
                    passwordInput.value = state.tempPostPassword || ''; // Mantener la contrase√±a si ya se escribi√≥
                    passwordInput.focus();
                }
                modal.classList.add('flex');
            }

            function closePostPasswordModal() {
                document.getElementById('postPasswordModal').classList.remove('flex');
                document.getElementById('postPasswordModalNameInput').value = '';
                document.getElementById('postPasswordModalInput').value = '';
            }

            function confirmPostPassword() {
                state.tempPostName = document.getElementById('postPasswordModalNameInput').value.trim();
                state.tempPostPassword = document.getElementById('postPasswordModalInput').value.trim();
                closePostPasswordModal();
            }

            // --- Funciones del Juego de Tarot ---
            function setupTarotGame() {
                console.log("Configurando juego de Tarot...");
                updateUiForView();
                state.tarotDeck = [...tarotDeckData];
                const spreadContainer = document.getElementById('tarotSpreadContainer');
                const initialCardContainer = document.getElementById('tarotInitialCardContainer');
                const cardInfoDisplay = document.getElementById('tarotCardInfoDisplay');

                spreadContainer.innerHTML = '';
                if (cardInfoDisplay) cardInfoDisplay.classList.add('hidden');
                if (initialCardContainer) initialCardContainer.classList.remove('hidden');

                const tarotDeckCard = document.getElementById('tarotDeckCard');
                if (tarotDeckCard) {
                    tarotDeckCard.classList.remove('spin');
                    tarotDeckCard.style.opacity = '1';
                    tarotDeckCard.style.transform = 'rotateY(0deg) scale(1)';
                }
                state.tarotInitialCardFlipped = false;
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            async function shuffleAndDealTarot() {
                const initialCardContainer = document.getElementById('tarotInitialCardContainer');
                const tarotDeckCard = document.getElementById('tarotDeckCard');
                const spreadContainer = document.getElementById('tarotSpreadContainer');
                const cardInfoDisplay = document.getElementById('tarotCardInfoDisplay');

                if (tarotDeckCard) {
                    tarotDeckCard.classList.add('spin');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    if (initialCardContainer) initialCardContainer.classList.add('hidden');
                }

                spreadContainer.innerHTML = '';
                if (cardInfoDisplay) cardInfoDisplay.classList.add('hidden');

                shuffleArray(state.tarotDeck);
                state.tarotSpread = state.tarotDeck.slice(0, 15);

                let cardIndex = 0;
                const rows = [5, 4, 3, 2, 1];

                function dealRowSequentially(rowIndex) {
                    if (rowIndex >= rows.length) return;

                    const numCardsInRow = rows[rowIndex];
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'tarot-row';
                    spreadContainer.appendChild(rowDiv);

                    function dealCardInRowSequentially(cardInRowIndex) {
                        if (cardInRowIndex >= numCardsInRow || cardIndex >= state.tarotSpread.length) {
                            setTimeout(() => dealRowSequentially(rowIndex + 1), 100);
                            return;
                        }

                        const cardData = state.tarotSpread[cardIndex];
                        const cardElement = document.createElement('div');
                        cardElement.className = 'tarot-card';
                        cardElement.dataset.cardIndex = cardIndex;

                        cardElement.innerHTML = `
                            <div class="card-face card-back">üîÆ</div>
                            <div class="card-face card-front">
                                <img src="${cardData.urlcart}" alt="${DOMPurify.sanitize(cardData.namecart)}" class="tarot-image-display"/>
                                </div>`;

                        cardElement.addEventListener('click', () => flipTarotCard(cardElement, cardData));
                        rowDiv.appendChild(cardElement);

                        void cardElement.offsetWidth;
                        cardElement.classList.add('placed');

                        cardIndex++;
                        setTimeout(() => dealCardInRowSequentially(cardInRowIndex + 1), 150);
                    }
                    dealCardInRowSequentially(0);
                }
                dealRowSequentially(0);
            }

            function flipTarotCard(cardElement, cardData) {
                const isCurrentlyFlipped = cardElement.classList.contains('flipped');
                const cardInfoDisplay = document.getElementById('tarotCardInfoDisplay');

                if (isCurrentlyFlipped && cardElement.classList.contains('selected-for-info')) {
                    cardElement.classList.remove('flipped');
                    cardElement.classList.remove('selected-for-info');
                    if (cardInfoDisplay) cardInfoDisplay.classList.add('hidden');
                    return;
                }

                document.querySelectorAll('.tarot-card.flipped').forEach(c => {
                    if (c !== cardElement) {
                        c.classList.remove('flipped');
                        c.classList.remove('selected-for-info');
                    }
                });

                cardElement.classList.add('flipped');
                cardElement.classList.add('selected-for-info');


                document.getElementById('tarotCardNameInfo').textContent = cardData.namecart;
                document.getElementById('tarotCardImageInfo').src = cardData.urlcart;
                document.getElementById('tarotCardImageInfo').alt = cardData.namecart;
                document.getElementById('tarotMeaningUpInfo').textContent = cardData.significado1cart;
                document.getElementById('tarotMeaningRevInfo').textContent = cardData.significado2cart;
                document.getElementById('tarotQuestionInfo').textContent = cardData.significado3cart;

                if (cardInfoDisplay) cardInfoDisplay.classList.remove('hidden');
            }

             console.log("Script principal IIFE ejecutado completamente.");
        })();
    </script>
</body>
</html>
